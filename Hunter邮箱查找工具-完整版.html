<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…· - å®Œæ•´ç‰ˆ</title>
    
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        small {
            color: #666;
            font-size: 0.9em;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        /* APIå¯†é’¥å¡ç‰‡æ ·å¼ */
        .api-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #667eea;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-input-group input {
            flex: 1;
        }

        .btn-icon {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .api-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 14px;
        }

        .btn-info {
            background: #3182ce;
            color: white;
        }

        .btn-info:hover {
            background: #2c5282;
        }

        .api-status {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .api-status.success {
            color: #22543d;
            background: #c6f6d5;
        }

        .api-status.error {
            color: #742a2a;
            background: #fed7d7;
        }

        .api-status.testing {
            color: #92400e;
            background: #fef3c7;
        }

        .api-info {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .api-info ul {
            margin: 10px 0 0 20px;
            line-height: 1.8;
        }

        /* ç»“æœæ˜¾ç¤º */
        #results {
            margin-top: 30px;
        }

        .result-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 20px 0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .company-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .company-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .domain {
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .email-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .email-list {
            margin-top: 15px;
        }

        .email-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-address {
            font-family: 'Courier New', monospace;
            color: #2d3748;
            font-weight: 500;
        }

        .email-details {
            font-size: 0.9em;
            color: #666;
        }

        .confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .confidence-high {
            background: #c6f6d5;
            color: #22543d;
        }

        .confidence-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background: #fed7d7;
            color: #742a2a;
        }

        /* é‚®ç®±ç±»å‹æ ·å¼ */
        .email-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 5px;
        }

        .type-personal {
            background: #e6f3ff;
            color: #0066cc;
        }

        .type-generic {
            background: #fff4e6;
            color: #cc6600;
        }

        .type-unknown {
            background: #f0f0f0;
            color: #666;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é”™è¯¯æ¶ˆæ¯ */
        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* æ ¼å¼ä¿¡æ¯ */
        .format-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            color: #666;
        }

        .format-info strong {
            color: #333;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
            
            .btn {
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .company-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .email-count {
                margin-top: 10px;
            }
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        input[type="file"] {
            padding: 8px;
            background: #f8f9fa;
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…·</h1>
            <p>ä½¿ç”¨ Hunter.io API æŸ¥æ‰¾å…¬å¸åŸŸåçš„é‚®ç®±åœ°å€ - å®Œæ•´ç‹¬ç«‹ç‰ˆ</p>
        </header>

        <div class="main-content">
            <!-- APIå¯†é’¥è®¾ç½® -->
            <div class="card api-card">
                <h2>ğŸ”‘ API å¯†é’¥è®¾ç½®</h2>
                <div class="form-group">
                    <label for="apiKey">Hunter.io API å¯†é’¥:</label>
                    <div class="api-input-group">
                        <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ Hunter.io API å¯†é’¥" class="form-control">
                        <button onclick="toggleApiKeyVisibility()" class="btn-icon" title="æ˜¾ç¤º/éšè—å¯†é’¥">
                            <span id="toggleIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="api-actions">
                        <button onclick="saveApiKey()" class="btn btn-small btn-primary">ä¿å­˜å¯†é’¥</button>
                        <button onclick="clearApiKey()" class="btn btn-small btn-secondary">æ¸…é™¤å¯†é’¥</button>
                        <button onclick="testApiKey()" class="btn btn-small btn-info">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <small>
                        <span id="apiStatus" class="api-status"></span>
                        <br>
                        è·å–å¯†é’¥: <a href="https://hunter.io/api" target="_blank">https://hunter.io/api</a> | 
                        <a href="https://hunter.io/api-keys" target="_blank">ç®¡ç†å¯†é’¥</a>
                    </small>
                </div>
                <div class="api-info">
                    <p><strong>è¯´æ˜ï¼š</strong></p>
                    <ul>
                        <li>å¯†é’¥å°†å®‰å…¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</li>
                        <li>å…³é—­æµè§ˆå™¨åå¯†é’¥ä»ä¼šä¿ç•™</li>
                        <li>å¯†é’¥ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨æˆ–ä¿å­˜åœ¨æ–‡ä»¶ä¸­</li>
                        <li>å¦‚éœ€æ›´æ¢å¯†é’¥ï¼Œç‚¹å‡»"æ¸…é™¤å¯†é’¥"åé‡æ–°è¾“å…¥</li>
                    </ul>
                </div>
            </div>

            <!-- ChatGPT APIè®¾ç½® -->
            <div class="card api-card">
                <h2>ğŸ¤– ChatGPT API è®¾ç½®ï¼ˆå¯é€‰ï¼‰</h2>
                <div class="form-group">
                    <label for="openaiKey">OpenAI API å¯†é’¥:</label>
                    <div class="api-input-group">
                        <input type="password" id="openaiKey" placeholder="è¾“å…¥ä½ çš„ OpenAI API å¯†é’¥ï¼ˆsk-...ï¼‰" class="form-control">
                        <button onclick="toggleOpenAIKeyVisibility()" class="btn-icon" title="æ˜¾ç¤º/éšè—å¯†é’¥">
                            <span id="toggleOpenAIIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="api-actions">
                        <button onclick="saveOpenAIKey()" class="btn btn-small btn-primary">ä¿å­˜å¯†é’¥</button>
                        <button onclick="clearOpenAIKey()" class="btn btn-small btn-secondary">æ¸…é™¤å¯†é’¥</button>
                        <button onclick="testOpenAIKey()" class="btn btn-small btn-info">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <small>
                        <span id="openaiStatus" class="api-status"></span>
                        <br>
                        è·å–å¯†é’¥: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Keys</a>
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableNameGuessing" style="margin-right: 8px;">
                        å¯ç”¨æ™ºèƒ½åå­—çŒœæµ‹åŠŸèƒ½ï¼ˆå¯¹äºæ²¡æœ‰First Nameçš„ä¸ªäººé‚®ç®±ï¼‰
                    </label>
                    <small style="display: block; margin-top: 5px;">
                        å¯ç”¨åï¼ŒAIä¼šæ™ºèƒ½åˆ†æé‚®ç®±åœ°å€ï¼Œæå–æˆ–çŒœæµ‹åˆç†çš„åå­—å’Œå§“æ°
                    </small>
                </div>
                <div class="api-info">
                    <p><strong>åŠŸèƒ½è¯´æ˜ï¼š</strong></p>
                    <ul>
                        <li>AIä¼šæ™ºèƒ½åˆ†æé‚®ç®±åœ°å€ï¼Œæå–æˆ–çŒœæµ‹åˆç†çš„åå­—</li>
                        <li>å¯¹äºæ˜ç¡®çš„åå­—ï¼ˆå¦‚john.smith@ï¼‰ï¼ŒAIä¼šæå–å®Œæ•´åå­—</li>
                        <li>å¯¹äºå•ä¸ªé¦–å­—æ¯+å§“æ°æ¨¡å¼ï¼ˆå¦‚acarnes@ï¼‰ï¼ŒAIä¼šä¿å®ˆå¤„ç†ï¼Œä¿ç•™é¦–å­—æ¯ï¼ˆå¦‚A. Carnesï¼‰</li>
                        <li>å¯¹äºä¸æ¸…æ™°çš„æ¨¡å¼ï¼ˆå¦‚rgmora@ï¼‰ï¼ŒAIä¼šæå–å¯è¯†åˆ«éƒ¨åˆ†ï¼ˆå¦‚RG Moraï¼‰</li>
                        <li>AIä¼šæ ‡è®°å“ªäº›æ˜¯çŒœæµ‹çš„åå­—ï¼Œå“ªäº›æ˜¯æå–çš„åå­—</li>
                        <li>æ­¤åŠŸèƒ½éœ€è¦æ¶ˆè€—OpenAI APIç§¯åˆ†ï¼Œè¯·åˆç†ä½¿ç”¨</li>
                    </ul>
                </div>
            </div>

            <!-- å•ä¸ªåŸŸåæŸ¥æ‰¾ -->
            <div class="card">
                <h2>å•ä¸ªåŸŸåæŸ¥æ‰¾</h2>
                <div class="form-group">
                    <label for="singleDomain">åŸŸåæˆ–ç½‘å€:</label>
                    <input type="text" id="singleDomain" placeholder="ä¾‹å¦‚: example.com æˆ– https://www.example.com" class="form-control">
                </div>
                <div class="form-group">
                    <label for="companyName">å…¬å¸åç§° (å¯é€‰):</label>
                    <input type="text" id="companyName" placeholder="ä¾‹å¦‚: Example Inc." class="form-control">
                </div>
                <div class="form-group">
                    <label for="emailLimit">é‚®ç®±æ•°é‡é™åˆ¶:</label>
                    <input type="number" id="emailLimit" value="10" min="1" max="100" class="form-control">
                </div>
                <button onclick="searchSingle()" class="btn btn-primary">æŸ¥æ‰¾é‚®ç®±</button>
            </div>

            <!-- æ‰¹é‡æŸ¥æ‰¾ -->
            <div class="card">
                <h2>æ‰¹é‡åŸŸåæŸ¥æ‰¾</h2>
                <div class="form-group">
                    <label for="batchInput">åŸŸååˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea id="batchInput" rows="5" placeholder="example1.com
example2.com
https://example3.com" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label>æˆ–ä¸Šä¼ æ–‡ä»¶ (CSV/TXT):</label>
                    <input type="file" id="csvFile" accept=".csv,.txt" class="form-control">
                    <small>
                        æ”¯æŒæ ¼å¼ï¼š<br>
                        â€¢ CSV: company_name, domain/website<br>
                        â€¢ TXT: JSONæ ¼å¼ [{"company_name": "å…¬å¸å", "website": "ç½‘å€"}]
                    </small>
                </div>
                <button onclick="searchBatch()" class="btn btn-primary">æ‰¹é‡æŸ¥æ‰¾</button>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="results" class="card" style="display: none;">
                <h2>æŸ¥æ‰¾ç»“æœ</h2>
                <div id="resultContent"></div>
                <div class="actions">
                    <button onclick="downloadInstantlyCSV()" class="btn btn-primary">ä¸‹è½½ Instantly æ ¼å¼</button>
                    <button onclick="downloadFullCSV()" class="btn btn-secondary">ä¸‹è½½å®Œæ•´ CSV</button>
                    <button onclick="downloadJSON()" class="btn btn-secondary">ä¸‹è½½ JSON</button>
                    <button onclick="clearResults()" class="btn btn-secondary">æ¸…é™¤ç»“æœ</button>
                </div>
                <div class="format-info">
                    <small>
                        <strong>Instantlyæ ¼å¼</strong>ï¼šEmail, First Name, Last Name, Company Name, Phone, Job Title, Country<br>
                        <strong>å®Œæ•´CSV</strong>ï¼šåŒ…å«æ‰€æœ‰å­—æ®µå’Œç½®ä¿¡åº¦ä¿¡æ¯
                    </small>
                </div>
            </div>

            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>æ­£åœ¨æŸ¥æ‰¾é‚®ç®±...</p>
            </div>
        </div>

        <footer>
            <p>Â© 2025 Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…· - å®Œæ•´ç‹¬ç«‹ç‰ˆ | åŸºäº Hunter.io API</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨ç»“æœ
        let currentResults = [];
        
        // ç¼“å­˜çŒœæµ‹çš„åå­—ï¼Œé¿å…é‡å¤è°ƒç”¨API
        const nameGuessCache = new Map();

        // è·å–APIå¯†é’¥
        function getApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ Hunter.io API å¯†é’¥');
                return null;
            }
            return apiKey;
        }

        // å•ä¸ªåŸŸåæŸ¥æ‰¾
        async function searchSingle() {
            const apiKey = getApiKey();
            if (!apiKey) return;

            const domain = document.getElementById('singleDomain').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const limit = document.getElementById('emailLimit').value;

            if (!domain) {
                alert('è¯·è¾“å…¥åŸŸåæˆ–ç½‘å€');
                return;
            }

            showLoading(true);
            
            try {
                const result = await searchDomain(apiKey, domain, companyName, limit);
                
                // å¦‚æœå¯ç”¨äº†AIåŠŸèƒ½ï¼Œå¤„ç†é‚®ç®±
                const enableGuessing = document.getElementById('enableNameGuessing').checked;
                const openaiKey = localStorage.getItem('openaiApiKey');
                if (enableGuessing && openaiKey && result.success && result.emails) {
                    updateLoadingText('æ­£åœ¨ä½¿ç”¨AIæ™ºèƒ½ç”Ÿæˆç§°å‘¼...');
                    result.emails = await processEmailsWithAI(result.emails, result.company_name);
                }
                
                currentResults = [result];
                displayResults(currentResults);
            } catch (error) {
                alert('æŸ¥æ‰¾å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ‰¹é‡æŸ¥æ‰¾
        async function searchBatch() {
            const apiKey = getApiKey();
            if (!apiKey) return;

            let domains = [];
            
            // ä»æ–‡æœ¬æ¡†è·å–
            const batchText = document.getElementById('batchInput').value.trim();
            if (batchText) {
                domains = batchText.split('\n').map(line => ({
                    domain: line.trim(),
                    company_name: ''
                })).filter(item => item.domain);
            }
            
            // ä»æ–‡ä»¶è·å–ï¼ˆCSVæˆ–TXTï¼‰
            const fileInput = document.getElementById('csvFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileData = await readUploadedFile(file);
                domains = domains.concat(fileData);
            }
            
            if (domains.length === 0) {
                alert('è¯·è¾“å…¥åŸŸåæˆ–ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒCSV/TXTæ ¼å¼ï¼‰');
                return;
            }
            
            showLoading(true);
            currentResults = [];
            
            try {
                // æ‰¹é‡æŸ¥æ‰¾ï¼Œæ¯ä¸ªåŸŸåä¹‹é—´å»¶è¿Ÿ1ç§’
                for (let i = 0; i < domains.length; i++) {
                    const item = domains[i];
                    updateLoadingText(`æ­£åœ¨æŸ¥æ‰¾ ${i + 1}/${domains.length}: ${item.domain}`);
                    
                    try {
                        const result = await searchDomain(apiKey, item.domain, item.company_name);
                        
                        // å¦‚æœå¯ç”¨äº†AIåŠŸèƒ½ï¼Œå¤„ç†é‚®ç®±
                        const enableGuessing = document.getElementById('enableNameGuessing').checked;
                        const openaiKey = localStorage.getItem('openaiApiKey');
                        if (enableGuessing && openaiKey && result.success && result.emails) {
                            result.emails = await processEmailsWithAI(result.emails, result.company_name);
                        }
                        
                        currentResults.push(result);
                        displayResults(currentResults);
                    } catch (error) {
                        console.error(`Error for ${item.domain}:`, error);
                        currentResults.push({
                            company_name: item.company_name || item.domain,
                            domain: item.domain,
                            success: false,
                            error: error.message,
                            emails: []
                        });
                    }
                    
                    // å»¶è¿Ÿä»¥é¿å…é€Ÿç‡é™åˆ¶
                    if (i < domains.length - 1) {
                        await delay(1000);
                    }
                }
            } finally {
                showLoading(false);
            }
        }

        // è°ƒç”¨Hunter API
        async function searchDomain(apiKey, domain, companyName = '', limit = 10) {
            // æå–çº¯åŸŸå
            domain = extractDomain(domain);
            
            const url = `https://api.hunter.io/v2/domain-search?domain=${domain}&api_key=${apiKey}&limit=${limit}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('APIå¯†é’¥æ— æ•ˆ');
                    } else if (response.status === 429) {
                        throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    } else {
                        throw new Error(data.errors?.[0]?.details || 'è¯·æ±‚å¤±è´¥');
                    }
                }
                
                // å¤„ç†ç»“æœ
                const emails = data.data.emails || [];
                
                // è°ƒè¯•ï¼šæ‰“å°ç¬¬ä¸€ä¸ªé‚®ç®±çš„åŸå§‹æ•°æ®
                if (emails.length > 0) {
                    console.log('ç¬¬ä¸€ä¸ªé‚®ç®±çš„åŸå§‹æ•°æ®:', emails[0]);
                }
                
                const processedEmails = emails.map(email => {
                    const processed = {
                        email: email.value,
                        type: email.type || 'unknown',  // personal, generic, or unknown
                        first_name: email.first_name,
                        last_name: email.last_name,
                        position: email.position,
                        department: email.department,
                        confidence: email.confidence,
                        sources: email.sources?.length || 0
                    };
                    
                    // è°ƒè¯•ï¼šæ£€æŸ¥å¤„ç†åçš„æ•°æ®
                    console.log('å¤„ç†åçš„é‚®ç®±æ•°æ®:', processed);
                    return processed;
                });
                
                return {
                    company_name: companyName || data.data.organization || domain,
                    domain: domain,
                    success: true,
                    emails_found: emails.length,
                    emails: processedEmails,
                    pattern: data.data.pattern,
                    organization: data.data.organization
                };
            } catch (error) {
                throw error;
            }
        }

        // æå–åŸŸå
        function extractDomain(url) {
            // ç§»é™¤åè®®
            url = url.replace(/^https?:\/\//, '');
            // ç§»é™¤www
            url = url.replace(/^www\./, '');
            // ç§»é™¤è·¯å¾„
            url = url.split('/')[0];
            // ç§»é™¤ç«¯å£
            url = url.split(':')[0];
            return url;
        }

        // è¯»å–ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ”¯æŒCSVå’ŒTXT/JSONæ ¼å¼ï¼‰
        async function readUploadedFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const fileName = file.name.toLowerCase();
                    
                    try {
                        if (fileName.endsWith('.csv')) {
                            // å¤„ç†CSVæ ¼å¼
                            const lines = text.split('\n');
                            const results = [];
                            
                            for (let i = 1; i < lines.length; i++) { // è·³è¿‡æ ‡é¢˜è¡Œ
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const parts = line.split(',').map(p => p.trim());
                                if (parts.length >= 2) {
                                    results.push({
                                        company_name: parts[0],
                                        domain: parts[1]
                                    });
                                } else if (parts.length === 1) {
                                    results.push({
                                        company_name: '',
                                        domain: parts[0]
                                    });
                                }
                            }
                            
                            resolve(results);
                        } else if (fileName.endsWith('.txt')) {
                            // ä½¿ç”¨æ–°çš„JSONè§£ææ–¹æ³•
                            const { results, errors } = parseMultiArrayJSON(text);
                            
                            if (errors.length > 0) {
                                console.warn('JSONè§£æè­¦å‘Š:', errors);
                                alert(`æˆåŠŸè§£æ ${results.length} ä¸ªå…¬å¸\n\n${errors.length > 0 ? 'æ³¨æ„ï¼š\n' + errors.join('\n') : ''}`);
                            } else {
                                console.log(`æˆåŠŸè§£æ ${results.length} ä¸ªå…¬å¸`);
                            }
                            
                            resolve(results);
                        } else {
                            reject(new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        // JSONè§£ææ–¹æ³•
        function parseMultiArrayJSON(text) {
            const results = [];
            const errors = [];
            
            // å°†æ–‡æœ¬æŒ‰ ][ åˆ†å‰²æˆå¤šä¸ªæ•°ç»„
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // æŸ¥æ‰¾æ‰€æœ‰çš„JSONæ•°ç»„
            const arrayPattern = /\[\s*\{[\s\S]*?\}\s*\]/g;
            let match;
            let lastEnd = 0;
            
            while ((match = arrayPattern.exec(text)) !== null) {
                try {
                    // å°è¯•è§£ææ‰¾åˆ°çš„æ•°ç»„
                    const arrayStr = match[0];
                    const parsed = JSON.parse(arrayStr);
                    
                    if (Array.isArray(parsed)) {
                        parsed.forEach(item => {
                            results.push({
                                company_name: item.company_name || '',
                                domain: item.website || item.domain || ''
                            });
                        });
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤å¸¸è§é—®é¢˜
                    try {
                        let fixedStr = match[0]
                            .replace(/,\s*}/g, '}')  // ç§»é™¤å¯¹è±¡æœ«å°¾çš„é€—å·
                            .replace(/,\s*]/g, ']'); // ç§»é™¤æ•°ç»„æœ«å°¾çš„é€—å·
                        
                        const parsed = JSON.parse(fixedStr);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(item => {
                                results.push({
                                    company_name: item.company_name || '',
                                    domain: item.website || item.domain || ''
                                });
                            });
                            errors.push(`ä¿®å¤å¹¶è§£æäº†ä¸€ä¸ªæ ¼å¼é”™è¯¯çš„æ•°ç»„`);
                        }
                    } catch (e2) {
                        errors.push(`æ— æ³•è§£ææ•°ç»„: ${e2.message}`);
                    }
                }
                lastEnd = match.index + match[0].length;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ•°ç»„
            const remaining = text.substring(lastEnd).trim();
            if (remaining && remaining.startsWith('[')) {
                // å°è¯•ä¿®å¤å¹¶è§£ææœªå®Œæˆçš„æ•°ç»„
                try {
                    let fixedArray = remaining;
                    
                    // å¦‚æœæ²¡æœ‰ç»“æŸçš„ ]ï¼Œæ·»åŠ å®ƒ
                    if (!fixedArray.includes(']')) {
                        // æ‰¾åˆ°æœ€åä¸€ä¸ª }
                        const lastBrace = fixedArray.lastIndexOf('}');
                        if (lastBrace > -1) {
                            fixedArray = fixedArray.substring(0, lastBrace + 1) + '\n]';
                        }
                    }
                    
                    // ç§»é™¤å°¾éšé€—å·
                    fixedArray = fixedArray
                        .replace(/,\s*}/g, '}')
                        .replace(/,\s*]/g, ']');
                    
                    const parsed = JSON.parse(fixedArray);
                    if (Array.isArray(parsed)) {
                        parsed.forEach(item => {
                            results.push({
                                company_name: item.company_name || '',
                                domain: item.website || item.domain || ''
                            });
                        });
                        errors.push('å¤„ç†äº†æ–‡ä»¶æœ«å°¾çš„æœªå®Œæˆæ•°ç»„');
                    }
                } catch (e) {
                    errors.push(`æ— æ³•è§£ææ–‡ä»¶æœ«å°¾çš„å†…å®¹: ${e.message}`);
                }
            }
            
            return { results, errors };
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');
            
            resultsDiv.style.display = 'block';
            
            // ç»Ÿè®¡ä¿¡æ¯
            const totalCompanies = results.length;
            const successfulCompanies = results.filter(r => r.success).length;
            const totalEmails = results.reduce((sum, r) => sum + (r.emails_found || 0), 0);
            
            let html = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalCompanies}</div>
                        <div class="stat-label">æ€»å…¬å¸æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${successfulCompanies}</div>
                        <div class="stat-label">æˆåŠŸæŸ¥æ‰¾</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalEmails}</div>
                        <div class="stat-label">æ‰¾åˆ°é‚®ç®±</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${successfulCompanies > 0 ? Math.round(successfulCompanies/totalCompanies*100) : 0}%</div>
                        <div class="stat-label">æˆåŠŸç‡</div>
                    </div>
                </div>
            `;
            
            // è¯¦ç»†ç»“æœ
            results.forEach(result => {
                html += `<div class="result-item">`;
                
                if (result.success) {
                    html += `
                        <div class="company-info">
                            <div>
                                <div class="company-name">${result.company_name}</div>
                                <div class="domain">${result.domain}</div>
                            </div>
                            <div class="email-count">${result.emails_found} ä¸ªé‚®ç®±</div>
                        </div>
                    `;
                    
                    if (result.emails && result.emails.length > 0) {
                        html += '<div class="email-list">';
                        result.emails.forEach(email => {
                            const confidenceClass = email.confidence >= 80 ? 'confidence-high' : 
                                                  email.confidence >= 50 ? 'confidence-medium' : 'confidence-low';
                            
                            // é‚®ç®±ç±»å‹æ˜¾ç¤º
                            const typeDisplay = email.type === 'personal' ? 'ä¸ªäºº' : 
                                              email.type === 'generic' ? 'é€šç”¨' : 
                                              email.type === 'role' ? 'è§’è‰²' : 'æœªçŸ¥';
                            const typeClass = email.type === 'personal' ? 'type-personal' : 
                                            email.type === 'generic' ? 'type-generic' : 'type-unknown';
                            
                            html += `
                                <div class="email-item">
                                    <div>
                                        <div class="email-address">${email.email}</div>
                                        <div class="email-details">
                                            <span class="email-type ${typeClass}">${typeDisplay}</span>
                                            ${email.first_name || email.last_name ? `â€¢ ${email.first_name || ''} ${email.last_name || ''}` : ''}
                                            ${email.ai_generated ? `<span style="color: #667eea; font-size: 0.8em;">(AI${email.is_guess ? 'çŒœæµ‹' : 'æå–'})</span>` : ''}
                                            ${email.position ? `â€¢ ${email.position}` : ''}
                                            ${email.department ? `â€¢ ${email.department}` : ''}
                                        </div>
                                    </div>
                                    <span class="confidence ${confidenceClass}">å¯ä¿¡åº¦: ${email.confidence}%</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    if (result.pattern) {
                        html += `<div style="margin-top: 10px; color: #666;">é‚®ç®±æ¨¡å¼: ${result.pattern}</div>`;
                    }
                } else {
                    html += `
                        <div class="company-info">
                            <div>
                                <div class="company-name">${result.company_name}</div>
                                <div class="domain">${result.domain}</div>
                            </div>
                        </div>
                        <div class="error">é”™è¯¯: ${result.error}</div>
                    `;
                }
                
                html += '</div>';
            });
            
            resultContent.innerHTML = html;
        }

        // ä¸‹è½½CSVï¼ˆä¿ç•™è¿™ä¸ªå‡½æ•°ç”¨äºå…¼å®¹æ€§ï¼‰
        function downloadCSV() {
            downloadInstantlyCSV();
        }

        // ä¸‹è½½Instantly AIæ ¼å¼çš„CSV
        async function downloadInstantlyCSV() {
            if (currentResults.length === 0) return;
            
            try {
                // æ·»åŠ BOMä»¥æ”¯æŒExcelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡ï¼ˆUTF-8ç¼–ç ï¼‰
                const BOM = '\uFEFF';
                let csv = BOM + 'Email,First Name,Last Name,Company Name,Phone,Job Title,Country,Email Type,AI Generated\n';
                
                for (const result of currentResults) {
                    if (result.success && result.emails && result.emails.length > 0) {
                        // ç›´æ¥ä½¿ç”¨å·²ç»å¤„ç†è¿‡çš„é‚®ç®±æ•°æ®ï¼ˆåœ¨searchSingleæˆ–searchBatchæ—¶å·²ç»å¤„ç†è¿‡ï¼‰
                        for (const email of result.emails) {
                            // å¤„ç†First Nameï¼šå¦‚æœæ˜¯é€šç”¨é‚®ç®±ï¼Œä½¿ç”¨å…¬å¸å+Team
                            let firstName = email.first_name || '';
                            if ((email.type === 'generic' || email.type === 'role') && !firstName) {
                                // ç§»é™¤å…¬å¸åç§°åç¼€
                                const cleanCompanyName = cleanupCompanyName(result.company_name);
                                firstName = cleanCompanyName ? `${cleanCompanyName} Team` : '';
                            }
                            
                            // æŒ‰ç…§Instantly AIè¦æ±‚çš„å­—æ®µé¡ºåºï¼ŒåŠ ä¸Šè‡ªå®šä¹‰å­—æ®µ
                            const row = [
                                email.email || '',                    // Email (å¿…å¡«)
                                firstName,                            // First Name (å¤„ç†åçš„)
                                email.last_name || '',                // Last Name
                                result.company_name || '',            // Company Name
                                '',                                   // Phone (ç•™ç©º)
                                email.position || '',                 // Job Title
                                '',                                   // Country (ç•™ç©º)
                                email.type || 'unknown',              // Email Type (è‡ªå®šä¹‰å­—æ®µ)
                                email.ai_generated ? 'Yes' : 'No'     // AI Generated (æ ‡è®°æ˜¯å¦ä¸ºAIç”Ÿæˆ)
                            ];
                            
                            // è½¬ä¹‰å¤„ç†
                            const escapedRow = row.map(field => {
                                const str = String(field);
                                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                                    return `"${str.replace(/"/g, '""')}"`;
                                }
                                return str;  // Instantlyå¯èƒ½ä¸éœ€è¦æ‰€æœ‰å­—æ®µéƒ½åŠ å¼•å·
                            });
                            
                            csv += escapedRow.join(',') + '\n';
                        }
                    }
                    // æ³¨æ„ï¼šInstantlyæ ¼å¼ä¸­ï¼Œæ²¡æœ‰é‚®ç®±çš„å…¬å¸ä¸åŒ…å«åœ¨CSVä¸­
                }
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                downloadFile(csv, `instantly_contacts_${timestamp}.csv`, 'text/csv;charset=utf-8');
                
                // æç¤ºç”¨æˆ·
                const enableGuessing = document.getElementById('enableNameGuessing').checked;
                const openaiKey = localStorage.getItem('openaiApiKey');
                
                let alertMessage = 'å·²ä¸‹è½½Instantly AIæ ¼å¼çš„CSVæ–‡ä»¶\n\næ³¨æ„ï¼š\n- åªåŒ…å«æœ‰é‚®ç®±çš„è”ç³»äºº\n- Phoneå’ŒCountryå­—æ®µä¸ºç©ºï¼Œéœ€è¦æ—¶è¯·æ‰‹åŠ¨è¡¥å……\n- Email Typeå­—æ®µæ ‡è¯†é‚®ç®±ç±»å‹ï¼ˆpersonal/genericï¼‰\n- é€šç”¨é‚®ç®±çš„First Nameè‡ªåŠ¨è®¾ä¸º"å…¬å¸å Team"';
                
                if (enableGuessing && openaiKey) {
                    alertMessage += '\n- AI Generatedå­—æ®µæ ‡è¯†åå­—æ˜¯å¦ç”±AIç”Ÿæˆ';
                }
                
                alert(alertMessage);
                
            } catch (error) {
                console.error('Error downloading CSV:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¸‹è½½å®Œæ•´æ ¼å¼çš„CSVï¼ˆä¿ç•™æ‰€æœ‰ä¿¡æ¯ï¼‰
        function downloadFullCSV() {
            if (currentResults.length === 0) return;
            
            const BOM = '\uFEFF';
            let csv = BOM + 'Company Name,Domain,Email,Email Type,First Name,Last Name,Position,Department,Confidence\n';
            
            currentResults.forEach(result => {
                if (result.success && result.emails && result.emails.length > 0) {
                    result.emails.forEach(email => {
                        const row = [
                            result.company_name || '',
                            result.domain || '',
                            email.email || '',
                            email.type || 'unknown',
                            email.first_name || '',
                            email.last_name || '',
                            email.position || '',
                            email.department || '',
                            email.confidence !== undefined ? email.confidence : ''
                        ];
                        
                        const escapedRow = row.map(field => {
                            const str = String(field);
                            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                                return `"${str.replace(/"/g, '""')}"`;
                            }
                            return `"${str}"`;
                        });
                        
                        csv += escapedRow.join(',') + '\n';
                    });
                } else {
                    // åŒ…å«æ²¡æœ‰é‚®ç®±çš„å…¬å¸
                    csv += `"${result.company_name || ''}","${result.domain || ''}","","","","","","",""\n`;
                }
            });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadFile(csv, `hunter_full_results_${timestamp}.csv`, 'text/csv;charset=utf-8');
        }

        // ä¸‹è½½JSON
        function downloadJSON() {
            if (currentResults.length === 0) return;
            
            const json = JSON.stringify(currentResults, null, 2);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadFile(json, `hunter_results_${timestamp}.json`, 'application/json');
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            currentResults = [];
            document.getElementById('results').style.display = 'none';
            document.getElementById('singleDomain').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('batchInput').value = '';
            document.getElementById('csvFile').value = '';
        }

        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ›´æ–°åŠ è½½æ–‡å­—
        function updateLoadingText(text) {
            const loading = document.getElementById('loading');
            const p = loading.querySelector('p');
            if (p) {
                p.textContent = text;
            }
        }

        // å»¶è¿Ÿå‡½æ•°
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // APIå¯†é’¥ç®¡ç†åŠŸèƒ½
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showApiStatus('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            localStorage.setItem('hunterApiKey', apiKey);
            showApiStatus('APIå¯†é’¥å·²ä¿å­˜', 'success');
        }

        function clearApiKey() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„APIå¯†é’¥å—ï¼Ÿ')) {
                localStorage.removeItem('hunterApiKey');
                document.getElementById('apiKey').value = '';
                showApiStatus('APIå¯†é’¥å·²æ¸…é™¤', 'success');
            }
        }

        async function testApiKey() {
            const apiKey = getApiKey();
            if (!apiKey) return;
            
            showApiStatus('æµ‹è¯•è¿æ¥ä¸­...', 'testing');
            
            try {
                // ä½¿ç”¨ä¸€ä¸ªæµ‹è¯•åŸŸåæ¥éªŒè¯APIå¯†é’¥
                const testDomain = 'google.com';
                const url = `https://api.hunter.io/v2/domain-search?domain=${testDomain}&api_key=${apiKey}&limit=1`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    // è·å–è´¦æˆ·ä¿¡æ¯
                    const accountUrl = `https://api.hunter.io/v2/account?api_key=${apiKey}`;
                    const accountResponse = await fetch(accountUrl);
                    const accountData = await accountResponse.json();
                    
                    if (accountResponse.ok) {
                        const remaining = accountData.data.requests.searches.available;
                        const used = accountData.data.requests.searches.used;
                        showApiStatus(`è¿æ¥æˆåŠŸï¼å‰©ä½™æŸ¥è¯¢æ¬¡æ•°: ${remaining} (å·²ä½¿ç”¨: ${used})`, 'success');
                    } else {
                        showApiStatus('è¿æ¥æˆåŠŸï¼', 'success');
                    }
                } else {
                    if (response.status === 401) {
                        showApiStatus('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥', 'error');
                    } else {
                        showApiStatus(`è¿æ¥å¤±è´¥: ${data.errors?.[0]?.details || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    }
                }
            } catch (error) {
                showApiStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        function showApiStatus(message, type) {
            const statusElement = document.getElementById('apiStatus');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            
            // 3ç§’åè‡ªåŠ¨æ¸…é™¤éé”™è¯¯æ¶ˆæ¯
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = '';
                        statusElement.className = 'api-status';
                    }
                }, 3000);
            }
        }

        // æ¸…ç†å…¬å¸åç§°ï¼Œç§»é™¤å¸¸è§åç¼€
        function cleanupCompanyName(companyName) {
            if (!companyName) return '';
            
            // å¸¸è§çš„å…¬å¸åç¼€
            const suffixes = [
                // è‹±æ–‡åç¼€
                ', LLC', ' LLC', ', INC', ' INC', ', Inc.', ' Inc.', ', Inc', ' Inc',
                ', CORP', ' CORP', ', Corp.', ' Corp.', ', Corp', ' Corp',
                ', LTD', ' LTD', ', Ltd.', ' Ltd.', ', Ltd', ' Ltd',
                ', CO', ' CO', ', Co.', ' Co.', ', Co', ' Co',
                ', COMPANY', ' COMPANY', ', Company', ' Company',
                ', CORPORATION', ' CORPORATION', ', Corporation', ' Corporation',
                ', INCORPORATED', ' INCORPORATED', ', Incorporated', ' Incorporated',
                ', LIMITED', ' LIMITED', ', Limited', ' Limited',
                ', LP', ' LP', ', L.P.', ' L.P.',
                ', LLP', ' LLP', ', L.L.P.', ' L.L.P.',
                ', PC', ' PC', ', P.C.', ' P.C.',
                ', PA', ' PA', ', P.A.', ' P.A.',
                ', PLLC', ' PLLC', ', P.L.L.C.', ' P.L.L.C.',
                ', SERIES', ' SERIES', ', Series', ' Series',
                // ä¸­æ–‡åç¼€
                'æœ‰é™å…¬å¸', 'è‚¡ä»½æœ‰é™å…¬å¸', 'æœ‰é™è´£ä»»å…¬å¸', 'é›†å›¢', 'å…¬å¸'
            ];
            
            let cleanName = companyName.trim();
            
            // ç§»é™¤åç¼€
            for (const suffix of suffixes) {
                if (cleanName.endsWith(suffix)) {
                    cleanName = cleanName.substring(0, cleanName.length - suffix.length).trim();
                    break; // åªç§»é™¤ä¸€ä¸ªåç¼€
                }
            }
            
            // ç§»é™¤å¤šä½™çš„æ ‡ç‚¹ç¬¦å·
            cleanName = cleanName.replace(/[,.]$/, '').trim();
            
            return cleanName;
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ChatGPT APIç›¸å…³å‡½æ•°
        function toggleOpenAIKeyVisibility() {
            const openaiKeyInput = document.getElementById('openaiKey');
            const toggleIcon = document.getElementById('toggleOpenAIIcon');
            
            if (openaiKeyInput.type === 'password') {
                openaiKeyInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                openaiKeyInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function saveOpenAIKey() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            if (!openaiKey) {
                showOpenAIStatus('è¯·è¾“å…¥OpenAI APIå¯†é’¥', 'error');
                return;
            }
            
            localStorage.setItem('openaiApiKey', openaiKey);
            showOpenAIStatus('OpenAI APIå¯†é’¥å·²ä¿å­˜', 'success');
        }

        function clearOpenAIKey() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„OpenAI APIå¯†é’¥å—ï¼Ÿ')) {
                localStorage.removeItem('openaiApiKey');
                document.getElementById('openaiKey').value = '';
                showOpenAIStatus('OpenAI APIå¯†é’¥å·²æ¸…é™¤', 'success');
            }
        }

        async function testOpenAIKey() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            if (!openaiKey) {
                showOpenAIStatus('è¯·è¾“å…¥OpenAI APIå¯†é’¥', 'error');
                return;
            }
            
            showOpenAIStatus('æµ‹è¯•è¿æ¥ä¸­...', 'testing');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`
                    }
                });
                
                if (response.ok) {
                    showOpenAIStatus('è¿æ¥æˆåŠŸï¼APIå¯†é’¥æœ‰æ•ˆ', 'success');
                } else if (response.status === 401) {
                    showOpenAIStatus('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥', 'error');
                } else {
                    showOpenAIStatus('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                }
            } catch (error) {
                showOpenAIStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        function showOpenAIStatus(message, type) {
            const statusElement = document.getElementById('openaiStatus');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            
            if (type !== 'error') {
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = '';
                        statusElement.className = 'api-status';
                    }
                }, 3000);
            }
        }

        // ä½¿ç”¨ChatGPTçŒœæµ‹åå­—
        async function guessNameFromEmail(email, companyName) {
            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = `${email}|${companyName || ''}`;
            if (nameGuessCache.has(cacheKey)) {
                return nameGuessCache.get(cacheKey);
            }

            const openaiKey = localStorage.getItem('openaiApiKey');
            if (!openaiKey) {
                return { first_name: '', last_name: '' };
            }

            try {
                // æå–åŸŸåä½œä¸ºå…¬å¸åç§°
                const domain = email.split('@')[1];
                const domainName = domain.split('.')[0].toUpperCase();
                const companyDisplayName = companyName || domainName;
                
                const prompt = `ä½ æ˜¯ä¸€ä¸ªæ•°æ®æ¸…æ´—å’Œé‚®ä»¶å†™ä½œåŠ©ç†ï¼Œè¯·æ ¹æ®ä¸‹æ–¹æä¾›çš„é‚®ç®±ã€å…¬å¸åŸŸåã€å…¬å¸åç§°ç­‰ä¿¡æ¯ï¼Œæ™ºèƒ½ç”Ÿæˆé‚®ä»¶ç§°å‘¼ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

1. å¦‚æœé‚®ç®±å‰ç¼€åƒäººåï¼ˆå¦‚john.doeã€ashley.carnesã€john_smithï¼‰ï¼Œæå–åå­—å’Œå§“æ°ã€‚
2. å¦‚æœé‚®ç®±å‰ç¼€ä¸å«æ˜æ˜¾äººåï¼ˆå¦‚infoã€supportã€oquxiã€motrpã€evobç­‰ï¼‰ï¼Œæˆ–éš¾ä»¥åˆ¤æ–­ï¼Œä½¿ç”¨å…¬å¸åTeamã€‚
3. å¦‚æœæ˜¯å•ä¸ªé¦–å­—æ¯+å§“æ°ï¼ˆå¦‚acarnesã€jsmithï¼‰ï¼Œä¿å®ˆå¤„ç†ï¼Œä½¿ç”¨é¦–å­—æ¯å¤§å†™ã€‚
4. ä¸è¦éšæ„æ¨æ–­äººåï¼Œåªåœ¨æä¸ºæ˜æ˜¾æƒ…å†µä¸‹æ‰æ¨æµ‹ï¼›é‡åˆ°éš¾ä»¥åˆ¤æ–­çš„é‚®ç®±ï¼Œå®å¯é‡‡ç”¨å›¢é˜Ÿç§°å‘¼ã€‚

æ•°æ®ï¼š
- å…¬å¸å: ${companyDisplayName}
- åŸŸå: ${domain}
- é‚®ç®±: ${email}

è¯·åˆ†æåè¿”å›JSONæ ¼å¼ï¼š
{
    "greeting": "Dear John Smith," æˆ– "Dear TLRA Team," æˆ– "Dear A. Carnes,",
    "first_name": "John" æˆ– "TLRA Team" æˆ– "A.",
    "last_name": "Smith" æˆ– "" æˆ– "Carnes",
    "is_team": true/false
}

ä¾‹å­ï¼š
- acarnes@tlra.com â†’ {"greeting": "Dear A. Carnes,", "first_name": "A.", "last_name": "Carnes", "is_team": false}
- oquxi@tlra.com â†’ {"greeting": "Dear TLRA Team,", "first_name": "TLRA Team", "last_name": "", "is_team": true}
- john.smith@tlra.com â†’ {"greeting": "Dear John Smith,", "first_name": "John", "last_name": "Smith", "is_team": false}

é‡è¦ï¼šç›´æ¥è¿”å›çº¯JSONï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ã€‚`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',  // ä½¿ç”¨GPT-4 Turbo
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„é‚®ç®±åœ°å€åˆ†æå™¨ã€‚æ ¹æ®é‚®ç®±åœ°å€æ¨æµ‹åˆç†çš„åå­—å’Œå§“æ°ã€‚å¯¹äºé¦–å­—æ¯+å§“æ°çš„æ¨¡å¼ï¼ŒçŒœæµ‹å¸¸è§çš„åå­—ã€‚å¯¹äºä¸æ¸…æ™°çš„æ¨¡å¼å¦‚"oquxi"ï¼Œè¯†åˆ«ä¸ºå›¢é˜Ÿé‚®ç®±ã€‚å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.2,  // é™ä½æ¸©åº¦ä½¿è¾“å‡ºæ›´ç¨³å®š
                        max_tokens: 150
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content.trim();
                    
                    try {
                        // å¤„ç†å¯èƒ½çš„markdownä»£ç å—åŒ…è£¹
                        let cleanContent = content;
                        if (content.includes('```json')) {
                            cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        } else if (content.includes('```')) {
                            cleanContent = content.replace(/```\n?/g, '').trim();
                        }
                        
                        const result = JSON.parse(cleanContent);
                        
                        // ç¼“å­˜ç»“æœ
                        nameGuessCache.set(cacheKey, result);
                        
                        // é€‚é…æ–°çš„è¿”å›æ ¼å¼
                        const adaptedResult = {
                            first_name: result.first_name || '',
                            last_name: result.last_name || '',
                            is_guess: !result.is_team && result.first_name && result.first_name.length <= 2,
                            is_team: result.is_team || false,
                            greeting: result.greeting || ''
                        };
                        
                        return adaptedResult;
                    } catch (parseError) {
                        console.error('Error parsing AI response:', parseError);
                        console.error('Original content:', content);
                        return { first_name: '', last_name: '', is_guess: false };
                    }
                }
            } catch (error) {
                console.error('Error guessing name:', error);
            }

            return { first_name: '', last_name: '', is_guess: false };
        }

        // å¤„ç†é‚®ç®±åˆ—è¡¨ï¼Œæ·»åŠ AIçŒœæµ‹çš„åå­—
        async function processEmailsWithAI(emails, companyName) {
            const enableGuessing = document.getElementById('enableNameGuessing').checked;
            if (!enableGuessing) {
                return emails;
            }

            const openaiKey = localStorage.getItem('openaiApiKey');
            if (!openaiKey) {
                return emails;
            }

            // è®¡ç®—éœ€è¦å¤„ç†çš„é‚®ç®±æ•°é‡
            const personalEmailsWithoutName = emails.filter(e => e.type === 'personal' && !e.first_name);
            if (personalEmailsWithoutName.length === 0) {
                return emails;
            }

            // å¤„ç†æ¯ä¸ªé‚®ç®±
            const processedEmails = [];
            let processedCount = 0;
            
            for (const email of emails) {
                let processedEmail = { ...email };
                
                // åªå¤„ç†personalç±»å‹ä¸”æ²¡æœ‰first_nameçš„é‚®ç®±
                if (email.type === 'personal' && !email.first_name) {
                    processedCount++;
                    updateLoadingText(`æ­£åœ¨ä½¿ç”¨AIç”Ÿæˆç§°å‘¼ (${processedCount}/${personalEmailsWithoutName.length})...`);
                    
                    const guessedResult = await guessNameFromEmail(email.email, companyName);
                    if (guessedResult && (guessedResult.first_name || guessedResult.last_name)) {
                        // å¦‚æœAIçŒœæµ‹äº†åå­—ï¼Œæ›´æ–°é‚®ç®±ä¿¡æ¯
                        if (guessedResult.first_name) {
                            processedEmail.first_name = guessedResult.first_name;
                        }
                        if (guessedResult.last_name && !email.last_name) {
                            processedEmail.last_name = guessedResult.last_name;
                        }
                        processedEmail.ai_generated = true; // æ ‡è®°ä¸ºAIç”Ÿæˆ
                        processedEmail.is_guess = guessedResult.is_guess; // æ ‡è®°æ˜¯å¦ä¸ºçŒœæµ‹
                    }
                }
                
                processedEmails.push(processedEmail);
            }

            return processedEmails;
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä¿å­˜APIå¯†é’¥åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆè¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜ï¼‰
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', debounce(function() {
                    const apiKey = this.value ? this.value.trim() : '';
                    if (apiKey) {
                        localStorage.setItem('hunterApiKey', apiKey);
                    }
                }, 1000));
            }

            // æ¢å¤ä¿å­˜çš„APIå¯†é’¥
            const savedApiKey = localStorage.getItem('hunterApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                showApiStatus('å·²åŠ è½½ä¿å­˜çš„APIå¯†é’¥', 'success');
                // è‡ªåŠ¨æµ‹è¯•è¿æ¥
                setTimeout(() => {
                    testApiKey();
                }, 500);
            }

            // æ¢å¤ä¿å­˜çš„OpenAI APIå¯†é’¥
            const savedOpenAIKey = localStorage.getItem('openaiApiKey');
            if (savedOpenAIKey) {
                document.getElementById('openaiKey').value = savedOpenAIKey;
                showOpenAIStatus('å·²åŠ è½½ä¿å­˜çš„OpenAI APIå¯†é’¥', 'success');
            }

            // æ¢å¤æ™ºèƒ½çŒœæµ‹åå­—çš„è®¾ç½®
            const enableNameGuessing = localStorage.getItem('enableNameGuessing') === 'true';
            document.getElementById('enableNameGuessing').checked = enableNameGuessing;

            // ä¿å­˜æ™ºèƒ½çŒœæµ‹åå­—çš„è®¾ç½®
            document.getElementById('enableNameGuessing').addEventListener('change', function() {
                localStorage.setItem('enableNameGuessing', this.checked);
            });

            // OpenAIå¯†é’¥è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜
            const openaiKeyInput = document.getElementById('openaiKey');
            if (openaiKeyInput) {
                openaiKeyInput.addEventListener('input', debounce(function() {
                    const openaiKey = this.value ? this.value.trim() : '';
                    if (openaiKey) {
                        localStorage.setItem('openaiApiKey', openaiKey);
                    }
                }, 1000));
            }
        });
    </script>
</body>
</html>