<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…· - å®Œæ•´ç‰ˆ</title>
    
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-control {
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        small {
            color: #666;
            font-size: 0.9em;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        /* APIå¯†é’¥å¡ç‰‡æ ·å¼ */
        .api-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #667eea;
        }
        
        /* å±•å¼€/æ”¶èµ·æŒ‰é’®æ ·å¼ */
        .collapse-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
            user-select: none;
        }
        
        .collapse-toggle:hover {
            background-color: #f0f0f0;
        }
        
        .collapse-arrow {
            display: inline-block;
            transition: transform 0.3s;
            font-size: 0.8em;
        }
        
        .collapse-arrow.expanded {
            transform: rotate(90deg);
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .api-input-group input {
            flex: 1;
        }

        .btn-icon {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .api-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 14px;
        }

        .btn-info {
            background: #3182ce;
            color: white;
        }

        .btn-info:hover {
            background: #2c5282;
        }

        .api-status {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .api-status.success {
            color: #22543d;
            background: #c6f6d5;
        }

        .api-status.error {
            color: #742a2a;
            background: #fed7d7;
        }

        .api-status.testing {
            color: #92400e;
            background: #fef3c7;
        }

        .api-info {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .api-info ul {
            margin: 10px 0 0 20px;
            line-height: 1.8;
        }

        /* ç»“æœæ˜¾ç¤º */
        #results {
            margin-top: 30px;
        }

        .result-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 20px 0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .company-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .company-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .domain {
            color: #667eea;
            font-family: 'Courier New', monospace;
        }

        .email-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .email-list {
            margin-top: 15px;
        }

        .email-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-address {
            font-family: 'Courier New', monospace;
            color: #2d3748;
            font-weight: 500;
        }

        .email-details {
            font-size: 0.9em;
            color: #666;
        }

        .confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .confidence-high {
            background: #c6f6d5;
            color: #22543d;
        }

        .confidence-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .confidence-low {
            background: #fed7d7;
            color: #742a2a;
        }

        /* é‚®ç®±ç±»å‹æ ·å¼ */
        .email-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 5px;
        }

        .type-personal {
            background: #e6f3ff;
            color: #0066cc;
        }

        .type-generic {
            background: #fff4e6;
            color: #cc6600;
        }

        .type-unknown {
            background: #f0f0f0;
            color: #666;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é”™è¯¯æ¶ˆæ¯ */
        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* æ ¼å¼ä¿¡æ¯ */
        .format-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            color: #666;
        }

        .format-info strong {
            color: #333;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
            
            .btn {
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .company-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .email-count {
                margin-top: 10px;
            }
        }

        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        input[type="file"] {
            padding: 8px;
            background: #f8f9fa;
        }

        /* åˆ†é¡µæ§ä»¶æ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .pagination button:hover {
            background: #f5f5f5;
        }

        .pagination button:disabled {
            background: #f9f9f9;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-info {
            margin: 0 15px;
            color: #666;
            font-size: 14px;
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
        
        /* æ»šåŠ¨æŒ‰é’® */
        .scroll-buttons {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        
        .scroll-btn {
            width: 45px;
            height: 45px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            opacity: 0.8;
        }
        
        .scroll-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
            opacity: 1;
        }
        
        .scroll-btn:active {
            transform: scale(0.95);
        }
        
        /* éšè—/æ˜¾ç¤ºæ»šåŠ¨æŒ‰é’® */
        .scroll-buttons.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
    </style>
</head>
<body>
    <!-- æ»šåŠ¨æŒ‰é’® -->
    <div class="scroll-buttons">
        <button class="scroll-btn" onclick="scrollToTop()" title="å›åˆ°é¡¶éƒ¨">â†‘</button>
        <button class="scroll-btn" onclick="scrollToBottom()" title="å»åˆ°åº•éƒ¨">â†“</button>
    </div>
    
    <div class="container">
        <header>
            <h1>ğŸ” Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…·</h1>
            <p>ä½¿ç”¨ Hunter.io API æŸ¥æ‰¾å…¬å¸åŸŸåçš„é‚®ç®±åœ°å€ - å®Œæ•´ç‹¬ç«‹ç‰ˆ</p>
        </header>

        <div class="main-content">
            <!-- APIå¯†é’¥è®¾ç½® -->
            <div class="card api-card">
                <h2>ğŸ”‘ API å¯†é’¥è®¾ç½®</h2>
                <div class="form-group">
                    <label for="apiKey">Hunter.io API å¯†é’¥:</label>
                    <div class="api-input-group">
                        <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ Hunter.io API å¯†é’¥" class="form-control">
                        <button onclick="toggleApiKeyVisibility()" class="btn-icon" title="æ˜¾ç¤º/éšè—å¯†é’¥">
                            <span id="toggleIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="api-actions">
                        <button onclick="saveApiKey()" class="btn btn-small btn-primary">ä¿å­˜å¯†é’¥</button>
                        <button onclick="clearApiKey()" class="btn btn-small btn-secondary">æ¸…é™¤å¯†é’¥</button>
                        <button onclick="testApiKey()" class="btn btn-small btn-info">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <small>
                        <span id="apiStatus" class="api-status"></span>
                        <br>
                        è·å–å¯†é’¥: <a href="https://hunter.io/api" target="_blank">https://hunter.io/api</a> | 
                        <a href="https://hunter.io/api-keys" target="_blank">ç®¡ç†å¯†é’¥</a>
                    </small>
                </div>
                <div class="collapse-toggle" onclick="toggleApiInfo('hunter')">
                    <span class="collapse-arrow" id="hunterArrow">â–¶</span>
                    <span>è¯´æ˜</span>
                </div>
                <div class="api-info" id="hunterApiInfo" style="display: none;">
                    <ul>
                        <li>å¯†é’¥å°†å®‰å…¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</li>
                        <li>å…³é—­æµè§ˆå™¨åå¯†é’¥ä»ä¼šä¿ç•™</li>
                        <li>å¯†é’¥ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨æˆ–ä¿å­˜åœ¨æ–‡ä»¶ä¸­</li>
                        <li>å¦‚éœ€æ›´æ¢å¯†é’¥ï¼Œç‚¹å‡»"æ¸…é™¤å¯†é’¥"åé‡æ–°è¾“å…¥</li>
                    </ul>
                </div>
            </div>

            <!-- ChatGPT APIè®¾ç½® -->
            <div class="card api-card">
                <h2>ğŸ¤– ChatGPT API è®¾ç½®ï¼ˆå¯é€‰ï¼‰</h2>
                <div class="collapse-toggle" onclick="toggleApiInfo('openai')" style="margin-bottom: 15px;">
                    <span class="collapse-arrow" id="openaiArrow">â–¶</span>
                    <span>å±•å¼€è®¾ç½®</span>
                </div>
                <div id="openaiApiInfo" style="display: none;">
                <div class="form-group">
                    <label for="openaiKey">OpenAI API å¯†é’¥:</label>
                    <div class="api-input-group">
                        <input type="password" id="openaiKey" placeholder="è¾“å…¥ä½ çš„ OpenAI API å¯†é’¥ï¼ˆsk-...ï¼‰" class="form-control">
                        <button onclick="toggleOpenAIKeyVisibility()" class="btn-icon" title="æ˜¾ç¤º/éšè—å¯†é’¥">
                            <span id="toggleOpenAIIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="api-actions">
                        <button onclick="saveOpenAIKey()" class="btn btn-small btn-primary">ä¿å­˜å¯†é’¥</button>
                        <button onclick="clearOpenAIKey()" class="btn btn-small btn-secondary">æ¸…é™¤å¯†é’¥</button>
                        <button onclick="testOpenAIKey()" class="btn btn-small btn-info">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <small>
                        <span id="openaiStatus" class="api-status"></span>
                        <br>
                        è·å–å¯†é’¥: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Keys</a>
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableNameGuessing" checked style="margin-right: 8px;">
                        å¯ç”¨æ™ºèƒ½åå­—çŒœæµ‹åŠŸèƒ½
                    </label>
                    <small style="display: block; margin-top: 5px;">
                        å¯ç”¨åï¼ŒAIä¼šæ™ºèƒ½åˆ†æé‚®ç®±åœ°å€ï¼Œæå–æˆ–çŒœæµ‹åˆç†çš„åå­—å’Œå§“æ°
                    </small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="overrideExistingNames" style="margin-right: 8px;">
                        è¦†ç›–Hunteræä¾›çš„åå­—ï¼ˆä½¿ç”¨AIé‡æ–°åˆ†ææ‰€æœ‰é‚®ç®±ï¼‰
                    </label>
                    <small style="display: block; margin-top: 5px;">
                        å‹¾é€‰åï¼Œå³ä½¿Hunterå·²æä¾›åå­—ï¼ŒAIä¹Ÿä¼šé‡æ–°åˆ†æ
                    </small>
                </div>
                <div class="api-info" style="margin-top: 15px;">
                    <ul>
                        <li>AIä¼šæ™ºèƒ½åˆ†æé‚®ç®±åœ°å€ï¼Œæå–æˆ–çŒœæµ‹åˆç†çš„åå­—</li>
                        <li>å¯¹äºæ˜ç¡®çš„åå­—ï¼ˆå¦‚john.smith@ï¼‰ï¼ŒAIä¼šæå–å®Œæ•´åå­—</li>
                        <li>å¯¹äºå•ä¸ªé¦–å­—æ¯+å§“æ°æ¨¡å¼ï¼ˆå¦‚acarnes@ï¼‰ï¼ŒAIä¼šä¿å®ˆå¤„ç†ï¼Œä¿ç•™é¦–å­—æ¯ï¼ˆå¦‚A. Carnesï¼‰</li>
                        <li>å¯¹äºä¸æ¸…æ™°çš„æ¨¡å¼ï¼ˆå¦‚rgmora@ï¼‰ï¼ŒAIä¼šæå–å¯è¯†åˆ«éƒ¨åˆ†ï¼ˆå¦‚RG Moraï¼‰</li>
                        <li>AIä¼šæ ‡è®°å“ªäº›æ˜¯çŒœæµ‹çš„åå­—ï¼Œå“ªäº›æ˜¯æå–çš„åå­—</li>
                        <li>æ­¤åŠŸèƒ½éœ€è¦æ¶ˆè€—OpenAI APIç§¯åˆ†ï¼Œè¯·åˆç†ä½¿ç”¨</li>
                    </ul>
                </div>
                </div>
            </div>

            <!-- Claude APIè®¾ç½® -->
            <div class="card api-card">
                <h2>ğŸ¤– Claude API è®¾ç½®ï¼ˆå¯é€‰ï¼‰</h2>
                <div class="collapse-toggle" onclick="toggleApiInfo('claude')" style="margin-bottom: 15px;">
                    <span class="collapse-arrow" id="claudeArrow">â–¶</span>
                    <span>å±•å¼€è®¾ç½®</span>
                </div>
                <div id="claudeApiInfo" style="display: none;">
                <div class="form-group">
                    <label for="proxyUrl">ä»£ç†æœåŠ¡å™¨åœ°å€:</label>
                    <input type="text" id="proxyUrl" placeholder="http://localhost:3001" value="http://localhost:3001" class="form-control">
                    <small>Claude APIéœ€è¦é€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—®ã€‚<a href="#" onclick="showProxySetup(); return false;">æŸ¥çœ‹è®¾ç½®è¯´æ˜</a></small>
                </div>
                <div class="form-group">
                    <label for="claudeKey">Claude API å¯†é’¥:</label>
                    <div class="api-input-group">
                        <input type="password" id="claudeKey" placeholder="è¾“å…¥ä½ çš„ Claude API å¯†é’¥" class="form-control">
                        <button onclick="toggleClaudeKeyVisibility()" class="btn-icon" title="æ˜¾ç¤º/éšè—å¯†é’¥">
                            <span id="toggleClaudeIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <div class="api-actions">
                        <button onclick="saveClaudeKey()" class="btn btn-small btn-primary">ä¿å­˜å¯†é’¥</button>
                        <button onclick="clearClaudeKey()" class="btn btn-small btn-secondary">æ¸…é™¤å¯†é’¥</button>
                        <button onclick="testClaudeKey()" class="btn btn-small btn-info">æµ‹è¯•è¿æ¥</button>
                    </div>
                    <small>
                        <span id="claudeStatus" class="api-status"></span>
                        <br>
                        è·å–å¯†é’¥: <a href="https://console.anthropic.com/api" target="_blank">Anthropic Console</a>
                    </small>
                </div>
                <div class="form-group">
                    <label>é€‰æ‹©AIæä¾›å•†:</label>
                    <div style="margin-top: 10px;">
                        <label style="margin-right: 20px;">
                            <input type="radio" name="aiProvider" value="openai" id="useOpenAI" checked style="margin-right: 5px;">
                            ä½¿ç”¨ OpenAI (GPT-4)
                        </label>
                        <label>
                            <input type="radio" name="aiProvider" value="claude" id="useClaude" style="margin-right: 5px;">
                            ä½¿ç”¨ Claude (Haiku 3.5)
                        </label>
                    </div>
                    <small style="display: block; margin-top: 10px;">
                        é€‰æ‹©ç”¨äºæ™ºèƒ½åå­—çŒœæµ‹çš„AIæœåŠ¡ã€‚ä¸¤è€…æ•ˆæœç›¸ä¼¼ï¼Œå¯æ ¹æ®æ‚¨çš„å¯†é’¥æƒ…å†µé€‰æ‹©ã€‚
                    </small>
                </div>
                <div class="api-info" style="margin-top: 15px;">
                    <ul>
                        <li>Claude AI æä¾›ä¸ OpenAI ç›¸ä¼¼çš„æ™ºèƒ½åˆ†æåŠŸèƒ½</li>
                        <li>ä½¿ç”¨ Claude 3.5 Haiku æ¨¡å‹ï¼Œé€Ÿåº¦å¿«ã€æˆæœ¬æä½</li>
                        <li>å¯¹äºé‚®ç®±åœ°å€çš„åå­—æå–å’Œåˆ†ææ•ˆæœè‰¯å¥½</li>
                        <li>API è°ƒç”¨è´¹ç”¨æ¯” GPT-4 å’Œ Sonnet éƒ½è¦ä½å¾ˆå¤š</li>
                        <li>æ”¯æŒæ‰¹é‡å¤„ç†ï¼Œæé«˜æ•ˆç‡</li>
                    </ul>
                </div>
                </div>
            </div>

            <!-- å•ä¸ªåŸŸåæŸ¥æ‰¾ -->
            <div class="card">
                <h2>å•ä¸ªåŸŸåæŸ¥æ‰¾</h2>
                <div class="collapse-toggle" onclick="toggleSection('singleSearch')" style="margin-bottom: 15px;">
                    <span class="collapse-arrow" id="singleSearchArrow">â–¶</span>
                    <span>å±•å¼€æŸ¥æ‰¾ç•Œé¢</span>
                </div>
                <div id="singleSearchSection" style="display: none;">
                <div class="form-group">
                    <label for="singleDomain">åŸŸåæˆ–ç½‘å€:</label>
                    <input type="text" id="singleDomain" placeholder="ä¾‹å¦‚: example.com æˆ– https://www.example.com" class="form-control">
                </div>
                <div class="form-group">
                    <label for="companyName">å…¬å¸åç§° (å¯é€‰):</label>
                    <input type="text" id="companyName" placeholder="ä¾‹å¦‚: Example Inc." class="form-control">
                </div>
                <div class="form-group">
                    <label for="emailLimit">é‚®ç®±æ•°é‡é™åˆ¶:</label>
                    <input type="number" id="emailLimit" value="10" min="1" max="100" class="form-control">
                </div>
                <button onclick="searchSingle()" class="btn btn-primary">æŸ¥æ‰¾é‚®ç®±</button>
                </div>
            </div>

            <!-- æ‰¹é‡æŸ¥æ‰¾ -->
            <div class="card">
                <h2>æ‰¹é‡åŸŸåæŸ¥æ‰¾</h2>
                <div class="form-group">
                    <label for="batchInput">åŸŸååˆ—è¡¨ (æ¯è¡Œä¸€ä¸ª):</label>
                    <textarea id="batchInput" rows="5" placeholder="example1.com
example2.com
https://example3.com" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label>æˆ–ä¸Šä¼ æ–‡ä»¶ (CSV/TXT):</label>
                    <input type="file" id="csvFile" accept=".csv,.txt" class="form-control">
                    <small>
                        æ”¯æŒæ ¼å¼ï¼š<br>
                        â€¢ CSV: company_name, domain/website<br>
                        â€¢ TXT: JSONæ ¼å¼ [{"company_name": "å…¬å¸å", "website": "ç½‘å€"}]
                    </small>
                </div>
                <button onclick="searchBatch()" class="btn btn-primary">æ‰¹é‡æŸ¥æ‰¾</button>
            </div>

            <!-- JSONæ–‡ä»¶å¤„ç† -->
            <div class="card">
                <h2>ğŸ”§ JSONæ–‡ä»¶å¤„ç†å·¥å…·</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    ä¸Šä¼ åŒ…å«å…¬å¸ä¿¡æ¯çš„TXT/JSONæ–‡ä»¶ï¼Œè‡ªåŠ¨å»é‡ã€ä¿®å¤æ ¼å¼é”™è¯¯å¹¶æ ‡å‡†åŒ–æ•°æ®
                </p>
                <div class="collapse-toggle" onclick="toggleSection('jsonProcessor')" style="margin-bottom: 15px;">
                    <span class="collapse-arrow" id="jsonProcessorArrow">â–¶</span>
                    <span>å±•å¼€å¤„ç†ç•Œé¢</span>
                </div>
                <div id="jsonProcessorSection" style="display: none;">
                    <div class="form-group">
                        <label for="jsonFile">é€‰æ‹©JSON/TXTæ–‡ä»¶:</label>
                        <input type="file" id="jsonFile" accept=".txt,.json" onchange="previewJsonFile()">
                        <small>
                            æ”¯æŒæ ¼å¼ï¼š<br>
                            â€¢ å•ä¸ªæ•°ç»„ï¼š[{"company_name": "å…¬å¸å", "website": "ç½‘å€"}]<br>
                            â€¢ å¤šä¸ªæ•°ç»„ï¼š[{...}][{...}]...<br>
                            â€¢ è‡ªåŠ¨ä¿®å¤å¸¸è§JSONé”™è¯¯ï¼ˆå°¾éšé€—å·ç­‰ï¼‰
                        </small>
                    </div>
                    <div id="jsonPreview" style="display: none; margin-top: 15px;">
                        <h3 style="font-size: 16px; margin-bottom: 10px;">æ–‡ä»¶é¢„è§ˆ</h3>
                        <div id="jsonPreviewContent" style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-family: monospace;"></div>
                        <div style="margin-top: 10px;">
                            <small>åŸå§‹æ•°æ®ç»Ÿè®¡ï¼š<span id="jsonStats" style="font-weight: bold;"></span></small>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" id="removeDuplicates" checked>
                            å»é™¤é‡å¤æ•°æ®ï¼ˆåŸºäºåŸŸåï¼‰
                        </label>
                    </div>
                    <button onclick="processJsonFile()" class="btn btn-primary">å¤„ç†æ–‡ä»¶</button>
                    
                    <!-- å¤„ç†ç»“æœæ˜¾ç¤º -->
                    <div id="jsonResults" style="display: none; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 5px;">
                        <h3 style="font-size: 16px; margin-bottom: 10px; color: #22543d;">âœ… å¤„ç†å®Œæˆ</h3>
                        <p id="jsonResultText" style="margin-bottom: 15px;"></p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="downloadProcessedJson()" class="btn btn-primary">ä¸‹è½½JSONæ ¼å¼</button>
                            <button onclick="downloadProcessedCsv()" class="btn btn-primary">ä¸‹è½½CSVæ ¼å¼</button>
                            <button onclick="copyToClipboard()" class="btn btn-secondary">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                            <button onclick="clearJsonResults()" class="btn btn-secondary">æ¸…é™¤ç»“æœ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSVæ–‡ä»¶ç§°å‘¼ç”Ÿæˆ -->
            <div class="card">
                <h2>ğŸ“ CSVæ–‡ä»¶ç§°å‘¼ç”Ÿæˆ</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    ä¸Šä¼ å·²æœ‰çš„CSVæ–‡ä»¶ï¼ˆå¦‚ä»Instantlyå¯¼å‡ºçš„ï¼‰ï¼Œä»…ä½¿ç”¨AIç”Ÿæˆç§°å‘¼ï¼Œæ— éœ€è°ƒç”¨Hunter API
                </p>
                <div class="collapse-toggle" onclick="toggleSection('csvGreeting')" style="margin-bottom: 15px;">
                    <span class="collapse-arrow" id="csvGreetingArrow">â–¶</span>
                    <span>å±•å¼€ç”Ÿæˆç•Œé¢</span>
                </div>
                <div id="csvGreetingSection" style="display: none;">
                <div class="form-group">
                    <label for="greetingCsvFile">é€‰æ‹©CSVæ–‡ä»¶:</label>
                    <input type="file" id="greetingCsvFile" accept=".csv" onchange="previewCsvFile()">
                    <small>æ”¯æŒæ ¼å¼ï¼šCSVæ–‡ä»¶ï¼ŒåŒ…å«emailåˆ—</small>
                </div>
                <div id="csvPreview" style="display: none; margin-top: 15px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">æ–‡ä»¶é¢„è§ˆ</h3>
                    <div id="csvPreviewContent" style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
                    <div style="margin-top: 10px;">
                        <small>æ£€æµ‹åˆ°çš„åˆ—ï¼š<span id="detectedColumns" style="font-weight: bold;"></span></small>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="overrideGreetings">
                        è¦†ç›–å·²æœ‰çš„åå­—ï¼ˆé»˜è®¤ä»…å¤„ç†ç©ºç™½åå­—ï¼‰
                    </label>
                </div>
                <button onclick="generateGreetingsOnly()" class="btn btn-primary">ç”Ÿæˆç§°å‘¼</button>
                
                <!-- ç”Ÿæˆç»“æœæ˜¾ç¤º -->
                <div id="greetingResults" style="display: none; margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 5px;">
                    <h3 style="font-size: 16px; margin-bottom: 10px; color: #22543d;">âœ… ç§°å‘¼ç”Ÿæˆå®Œæˆ</h3>
                    <p id="greetingResultText" style="margin-bottom: 15px;"></p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="downloadGeneratedGreetings()" class="btn btn-primary">ä¸‹è½½ç”Ÿæˆçš„æ–‡ä»¶</button>
                        <button onclick="clearGreetingResults()" class="btn btn-secondary">æ¸…é™¤ç»“æœ</button>
                    </div>
                </div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div id="results" class="card" style="display: none;">
                <h2>æŸ¥æ‰¾ç»“æœ</h2>
                <div id="resultContent"></div>
                <div class="actions">
                    <button onclick="downloadInstantlyCSV()" class="btn btn-primary">ä¸‹è½½ Instantly æ ¼å¼</button>
                    <button onclick="downloadFailedCompaniesCSV()" class="btn btn-secondary">ä¸‹è½½æœªæ‰¾åˆ°é‚®ç®±çš„å…¬å¸</button>
                    <button onclick="clearResults()" class="btn btn-secondary">æ¸…é™¤ç»“æœ</button>
                </div>
                <div class="format-info">
                    <small>
                        <strong>Instantlyæ ¼å¼</strong>ï¼šEmail, First Name, Last Name, Company Name, Phone, Job Title, Country<br>
                        <strong>æœªæ‰¾åˆ°é‚®ç®±çš„å…¬å¸</strong>ï¼šåŒ…å«æŸ¥æ‰¾å¤±è´¥æˆ–æ²¡æœ‰æ‰¾åˆ°é‚®ç®±çš„å…¬å¸åˆ—è¡¨
                    </small>
                </div>
            </div>

            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>æ­£åœ¨æŸ¥æ‰¾é‚®ç®±...</p>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="card" style="margin-top: 20px;">
            <h2>ğŸ”§ ç³»ç»Ÿæ—¥å¿—</h2>
            <div style="margin-bottom: 15px;">
                <button onclick="AppLogger.exportLogs()" class="btn btn-small btn-secondary">å¯¼å‡ºæ—¥å¿—</button>
                <button onclick="refreshLogDisplay()" class="btn btn-small btn-primary">åˆ·æ–°</button>
                <button onclick="AppLogger.clearLogs(); refreshLogDisplay();" class="btn btn-small btn-secondary">æ¸…é™¤æ—¥å¿—</button>
                <button onclick="toggleLogPanel()" class="btn btn-small btn-info">æ˜¾ç¤º/éšè—</button>
            </div>
            <div id="logPanel" style="display: none;">
                <div style="max-height: 300px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                    <div id="logContent"></div>
                </div>
            </div>
        </div>

        <footer>
            <p>Â© 2025 Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…· - å®Œæ•´ç‹¬ç«‹ç‰ˆ | åŸºäº Hunter.io API</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨ç»“æœ
        let currentResults = [];
        
        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        const resultsPerPage = 50;
        
        // ç¼“å­˜çŒœæµ‹çš„åå­—ï¼Œé¿å…é‡å¤è°ƒç”¨API
        const nameGuessCache = new Map();
        
        // Claudeä»£ç†æœåŠ¡å™¨URLï¼ˆæœ¬åœ°å¼€å‘æ—¶ä½¿ç”¨localhost:3001ï¼‰
        let CLAUDE_PROXY_URL = localStorage.getItem('claudeProxyUrl') || 'http://localhost:3001';
        
        // æ—¥å¿—ç³»ç»Ÿ
        const AppLogger = {
            logs: [],
            maxLogs: 1000,
            
            log: function(level, message, data = {}) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    level: level,
                    message: message,
                    data: data,
                    userAgent: navigator.userAgent
                };
                
                this.logs.push(logEntry);
                
                // ä¿æŒæ—¥å¿—æ•°é‡åœ¨é™åˆ¶å†…
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }
                
                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
                console.log(`[${level}] ${message}`, data);
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                this.saveLogs();
            },
            
            info: function(message, data) {
                this.log('INFO', message, data);
            },
            
            error: function(message, data) {
                this.log('ERROR', message, data);
            },
            
            warn: function(message, data) {
                this.log('WARN', message, data);
            },
            
            debug: function(message, data) {
                this.log('DEBUG', message, data);
            },
            
            saveLogs: function() {
                try {
                    localStorage.setItem('hunterAppLogs', JSON.stringify(this.logs));
                } catch (e) {
                    console.error('Failed to save logs:', e);
                }
            },
            
            loadLogs: function() {
                try {
                    const saved = localStorage.getItem('hunterAppLogs');
                    if (saved) {
                        this.logs = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Failed to load logs:', e);
                }
            },
            
            getLogs: function(level = null) {
                if (level) {
                    return this.logs.filter(log => log.level === level);
                }
                return this.logs;
            },
            
            exportLogs: function() {
                const logText = this.logs.map(log => 
                    `[${log.timestamp}] [${log.level}] ${log.message} ${JSON.stringify(log.data)}`
                ).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `hunter-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },
            
            clearLogs: function() {
                this.logs = [];
                this.saveLogs();
            }
        };

        // è·å–APIå¯†é’¥
        function getApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥ Hunter.io API å¯†é’¥');
                return null;
            }
            return apiKey;
        }

        // å•ä¸ªåŸŸåæŸ¥æ‰¾
        async function searchSingle() {
            const apiKey = getApiKey();
            if (!apiKey) return;

            const domain = document.getElementById('singleDomain').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const limit = document.getElementById('emailLimit').value;

            if (!domain) {
                alert('è¯·è¾“å…¥åŸŸåæˆ–ç½‘å€');
                return;
            }
            
            AppLogger.info('å¼€å§‹å•ä¸ªåŸŸåæŸ¥æ‰¾', { domain, companyName, limit });
            showLoading(true);
            
            try {
                const result = await searchDomain(apiKey, domain, companyName, limit);
                currentResults = [result];
                
                // å¦‚æœå¯ç”¨äº†AIåŠŸèƒ½ï¼Œæ‰¹é‡å¤„ç†é‚®ç®±
                const enableGuessing = document.getElementById('enableNameGuessing').checked;
                const useOpenAI = document.getElementById('useOpenAI').checked;
                const openaiKey = localStorage.getItem('openaiApiKey');
                const claudeKey = localStorage.getItem('claudeApiKey');
                const hasValidKey = useOpenAI ? openaiKey : claudeKey;
                
                if (enableGuessing && hasValidKey && result.success && result.emails) {
                    updateLoadingText('æ­£åœ¨ä½¿ç”¨AIæ™ºèƒ½ç”Ÿæˆç§°å‘¼...');
                    
                    // æ”¶é›†éœ€è¦å¤„ç†çš„é‚®ç®±
                    const overrideExisting = document.getElementById('overrideExistingNames').checked;
                    const emailsToProcess = [];
                    result.emails.forEach((email, index) => {
                        const shouldProcess = (email.type === 'personal' || email.type === 'generic') && 
                                            (overrideExisting || !email.first_name);
                        if (shouldProcess) {
                            emailsToProcess.push({
                                email: email.email,
                                companyName: result.company_name,
                                index: index
                            });
                        }
                    });
                    
                    AppLogger.info('AIå¤„ç†é‚®ç®±', { 
                        totalEmails: result.emails.length,
                        toProcess: emailsToProcess.length,
                        overrideExisting 
                    });
                    
                    if (emailsToProcess.length > 0) {
                        // æ‰¹é‡å¤„ç†
                        const batch = emailsToProcess.map(item => ({
                            email: item.email,
                            companyName: item.companyName
                        }));
                        
                        const aiResults = await batchProcessEmailsWithAI(batch);
                        
                        // åº”ç”¨AIç»“æœ
                        emailsToProcess.forEach(item => {
                            const aiResult = aiResults.get(item.email);
                            if (aiResult) {
                                const email = result.emails[item.index];
                                if (aiResult.first_name) {
                                    email.first_name = aiResult.first_name;
                                }
                                if (aiResult.last_name && !email.last_name) {
                                    email.last_name = aiResult.last_name;
                                }
                                email.ai_generated = true;
                                email.is_guess = aiResult.is_guess;
                            }
                        });
                    }
                }
                
                displayResults(currentResults);
                AppLogger.info('å•ä¸ªåŸŸåæŸ¥æ‰¾æˆåŠŸ', { 
                    domain, 
                    emailsFound: result.emails_found || 0,
                    success: result.success 
                });
            } catch (error) {
                AppLogger.error('å•ä¸ªåŸŸåæŸ¥æ‰¾å¤±è´¥', { domain, error: error.message });
                alert('æŸ¥æ‰¾å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ‰¹é‡æŸ¥æ‰¾
        async function searchBatch() {
            const apiKey = getApiKey();
            if (!apiKey) return;

            let domains = [];
            
            // ä»æ–‡æœ¬æ¡†è·å–
            const batchText = document.getElementById('batchInput').value.trim();
            if (batchText) {
                domains = batchText.split('\n').map(line => ({
                    domain: line.trim(),
                    company_name: ''
                })).filter(item => item.domain);
            }
            
            // ä»æ–‡ä»¶è·å–ï¼ˆCSVæˆ–TXTï¼‰
            const fileInput = document.getElementById('csvFile');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileData = await readUploadedFile(file);
                domains = domains.concat(fileData);
            }
            
            if (domains.length === 0) {
                alert('è¯·è¾“å…¥åŸŸåæˆ–ä¸Šä¼ æ–‡ä»¶ï¼ˆæ”¯æŒCSV/TXTæ ¼å¼ï¼‰');
                return;
            }
            
            // æ·»åŠ æ‰¹é‡å¤„ç†æ•°é‡é™åˆ¶
            const maxBatchSize = 250;
            if (domains.length > maxBatchSize) {
                if (!confirm(`æ£€æµ‹åˆ° ${domains.length} ä¸ªå…¬å¸ï¼Œè¶…è¿‡å»ºè®®çš„ ${maxBatchSize} ä¸ªé™åˆ¶ã€‚\n\nå¤„ç†å¤§é‡æ•°æ®å¯èƒ½ä¼šï¼š\nâ€¢ æ¶ˆè€—è¾ƒå¤šAPIé…é¢\nâ€¢ å½±å“é¡µé¢æ€§èƒ½\nâ€¢ å¯èƒ½å¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±\n\nå»ºè®®åˆ†æ‰¹å¤„ç†ã€‚æ˜¯å¦ç»§ç»­å¤„ç†å‰ ${maxBatchSize} ä¸ªå…¬å¸ï¼Ÿ`)) {
                    return;
                }
                domains = domains.slice(0, maxBatchSize);
                alert(`å·²é™åˆ¶ä¸ºå‰ ${maxBatchSize} ä¸ªå…¬å¸è¿›è¡Œå¤„ç†`);
            }
            
            showLoading(true);
            currentResults = [];
            
            try {
                // ç¬¬ä¸€é˜¶æ®µï¼šæ‰¹é‡æŸ¥æ‰¾æ‰€æœ‰åŸŸå
                for (let i = 0; i < domains.length; i++) {
                    const item = domains[i];
                    updateLoadingText(`æ­£åœ¨æŸ¥æ‰¾ ${i + 1}/${domains.length}: ${item.domain}`);
                    
                    try {
                        const result = await searchDomain(apiKey, item.domain, item.company_name);
                        currentResults.push(result);
                        displayResults(currentResults);
                    } catch (error) {
                        console.error(`Error for ${item.domain}:`, error);
                        currentResults.push({
                            company_name: item.company_name || item.domain,
                            domain: item.domain,
                            success: false,
                            error: error.message,
                            emails: []
                        });
                    }
                    
                    // å»¶è¿Ÿä»¥é¿å…é€Ÿç‡é™åˆ¶
                    if (i < domains.length - 1) {
                        await delay(1000);
                    }
                }
                
                // ç¬¬äºŒé˜¶æ®µï¼šæ‰¹é‡å¤„ç†AIåå­—çŒœæµ‹ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                const enableGuessing = document.getElementById('enableNameGuessing').checked;
                const useOpenAI = document.getElementById('useOpenAI').checked;
                const openaiKey = localStorage.getItem('openaiApiKey');
                const claudeKey = localStorage.getItem('claudeApiKey');
                const hasValidKey = useOpenAI ? openaiKey : claudeKey;
                
                if (enableGuessing && hasValidKey) {
                    updateLoadingText('æ­£åœ¨ä½¿ç”¨AIæ™ºèƒ½ç”Ÿæˆç§°å‘¼...');
                    
                    // æ”¶é›†æ‰€æœ‰éœ€è¦å¤„ç†çš„é‚®ç®±ï¼ŒåŒæ—¶å»é‡
                    const overrideExisting = document.getElementById('overrideExistingNames').checked;
                    const emailsToProcess = new Map();
                    const emailToResults = new Map(); // è®°å½•é‚®ç®±å¯¹åº”çš„ç»“æœç´¢å¼•
                    
                    currentResults.forEach((result, resultIndex) => {
                        if (result.success && result.emails) {
                            result.emails.forEach((email, emailIndex) => {
                                const shouldProcess = (email.type === 'personal' || email.type === 'generic') && 
                                                    (overrideExisting || !email.first_name);
                                if (shouldProcess) {
                                    const key = email.email;
                                    if (!emailsToProcess.has(key)) {
                                        emailsToProcess.set(key, {
                                            email: email.email,
                                            companyName: result.company_name
                                        });
                                        emailToResults.set(key, []);
                                    }
                                    // è®°å½•è¿™ä¸ªé‚®ç®±åœ¨å“ªäº›ç»“æœä¸­å‡ºç°
                                    emailToResults.get(key).push({ resultIndex, emailIndex });
                                }
                            });
                        }
                    });
                    
                    // æ™ºèƒ½è®¡ç®—æ‰¹æ¬¡ç­–ç•¥
                    const emailArray = Array.from(emailsToProcess.values());
                    const totalEmails = emailArray.length;
                    let batchStrategy = [];
                    
                    if (totalEmails <= 30) {
                        batchStrategy = [totalEmails];
                    } else if (totalEmails <= 60) {
                        batchStrategy = [30, totalEmails - 30];
                    } else if (totalEmails <= 100) {
                        const fullBatches = Math.floor(totalEmails / 30);
                        const remainder = totalEmails % 30;
                        batchStrategy = Array(fullBatches).fill(30);
                        if (remainder > 0) {
                            if (remainder < 10 && fullBatches > 0) {
                                batchStrategy[batchStrategy.length - 1] += remainder;
                            } else {
                                batchStrategy.push(remainder);
                            }
                        }
                    } else {
                        const batchSize = 25;
                        const fullBatches = Math.floor(totalEmails / batchSize);
                        const remainder = totalEmails % batchSize;
                        batchStrategy = Array(fullBatches).fill(batchSize);
                        if (remainder > 0) {
                            if (remainder < 10 && fullBatches > 0) {
                                batchStrategy[batchStrategy.length - 1] += remainder;
                            } else {
                                batchStrategy.push(remainder);
                            }
                        }
                    }
                    
                    const strategyText = batchStrategy.map((size, index) => 
                        `ç¬¬${index + 1}æ‰¹: ${size}ä¸ª`
                    ).join(', ');
                    
                    updateLoadingText(`æ­£åœ¨ä¼˜åŒ–AIå¤„ç†ç­–ç•¥... å…±${totalEmails}ä¸ªé‚®ç®±å°†åˆ†${batchStrategy.length}æ‰¹å¤„ç†`);
                    await delay(500);
                    
                    // æŒ‰ç­–ç•¥æ‰¹é‡å¤„ç†
                    let processedCount = 0;
                    for (let batchIndex = 0; batchIndex < batchStrategy.length; batchIndex++) {
                        const batchSize = batchStrategy[batchIndex];
                        const batch = emailArray.slice(processedCount, processedCount + batchSize);
                        
                        updateLoadingText(`æ­£åœ¨å¤„ç†ç¬¬ ${batchIndex + 1}/${batchStrategy.length} æ‰¹ AIç§°å‘¼ç”Ÿæˆ (${processedCount + 1}-${processedCount + batch.length}/${totalEmails})...`);
                        
                        const aiResults = await batchProcessEmailsWithAI(batch);
                        
                        // å°†AIç»“æœåº”ç”¨å›åŸå§‹æ•°æ®
                        batch.forEach(item => {
                            const aiResult = aiResults.get(item.email);
                            if (aiResult) {
                                const positions = emailToResults.get(item.email);
                                positions.forEach(pos => {
                                    const email = currentResults[pos.resultIndex].emails[pos.emailIndex];
                                    if (aiResult.first_name) {
                                        email.first_name = aiResult.first_name;
                                    }
                                    if (aiResult.last_name && !email.last_name) {
                                        email.last_name = aiResult.last_name;
                                    }
                                    email.ai_generated = true;
                                    email.is_guess = aiResult.is_guess;
                                });
                            }
                        });
                        
                        processedCount += batch.length;
                        
                        // æ‰¹æ¬¡é—´å»¶è¿Ÿ
                        if (batchIndex < batchStrategy.length - 1) {
                            await delay(1000);
                        }
                    }
                    
                    // æ›´æ–°æ˜¾ç¤º
                    displayResults(currentResults);
                }
                
            } finally {
                showLoading(false);
            }
        }

        // è°ƒç”¨Hunter API
        async function searchDomain(apiKey, domain, companyName = '', limit = 10) {
            // æå–çº¯åŸŸå
            domain = extractDomain(domain);
            
            const url = `https://api.hunter.io/v2/domain-search?domain=${domain}&api_key=${apiKey}&limit=${limit}`;
            AppLogger.debug('è°ƒç”¨Hunter API', { domain, limit });
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (!response.ok) {
                    AppLogger.error('Hunter APIå“åº”é”™è¯¯', { 
                        domain, 
                        status: response.status,
                        error: data 
                    });
                    
                    if (response.status === 401) {
                        throw new Error('APIå¯†é’¥æ— æ•ˆ');
                    } else if (response.status === 429) {
                        throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                    } else {
                        throw new Error(data.errors?.[0]?.details || 'è¯·æ±‚å¤±è´¥');
                    }
                }
                
                // å¤„ç†ç»“æœ
                const emails = data.data.emails || [];
                
                AppLogger.info('Hunter APIè¿”å›ç»“æœ', { 
                    domain, 
                    emailCount: emails.length,
                    organization: data.data.organization,
                    pattern: data.data.pattern
                });
                
                // è°ƒè¯•ï¼šæ‰“å°ç¬¬ä¸€ä¸ªé‚®ç®±çš„åŸå§‹æ•°æ®
                if (emails.length > 0) {
                    AppLogger.debug('ç¬¬ä¸€ä¸ªé‚®ç®±åŸå§‹æ•°æ®', emails[0]);
                }
                
                const processedEmails = emails.map(email => {
                    const processed = {
                        email: email.value,
                        type: email.type || 'unknown',  // personal, generic, or unknown
                        first_name: email.first_name,
                        last_name: email.last_name,
                        position: email.position,
                        department: email.department,
                        confidence: email.confidence,
                        sources: email.sources?.length || 0
                    };
                    
                    // è°ƒè¯•ï¼šæ£€æŸ¥å¤„ç†åçš„æ•°æ®
                    console.log('å¤„ç†åçš„é‚®ç®±æ•°æ®:', processed);
                    return processed;
                });
                
                // å¼‚æ­¥æ›´æ–°é…é¢ä¿¡æ¯ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                updateApiQuota(apiKey).catch(console.error);
                
                return {
                    company_name: companyName || data.data.organization || domain,
                    domain: domain,
                    success: true,
                    emails_found: emails.length,
                    emails: processedEmails,
                    pattern: data.data.pattern,
                    organization: data.data.organization
                };
            } catch (error) {
                throw error;
            }
        }

        // æå–åŸŸå
        function extractDomain(url) {
            // ç§»é™¤åè®®
            url = url.replace(/^https?:\/\//, '');
            // ç§»é™¤www
            url = url.replace(/^www\./, '');
            // ç§»é™¤è·¯å¾„
            url = url.split('/')[0];
            // ç§»é™¤ç«¯å£
            url = url.split(':')[0];
            return url;
        }

        // è¯»å–ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ”¯æŒCSVå’ŒTXT/JSONæ ¼å¼ï¼‰
        async function readUploadedFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const fileName = file.name.toLowerCase();
                    
                    try {
                        if (fileName.endsWith('.csv')) {
                            // å¤„ç†CSVæ ¼å¼
                            const lines = text.split('\n');
                            const results = [];
                            
                            for (let i = 1; i < lines.length; i++) { // è·³è¿‡æ ‡é¢˜è¡Œ
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                const parts = line.split(',').map(p => p.trim());
                                if (parts.length >= 2) {
                                    results.push({
                                        company_name: parts[0],
                                        domain: parts[1]
                                    });
                                } else if (parts.length === 1) {
                                    results.push({
                                        company_name: '',
                                        domain: parts[0]
                                    });
                                }
                            }
                            
                            resolve(results);
                        } else if (fileName.endsWith('.txt')) {
                            // ä½¿ç”¨æ–°çš„JSONè§£ææ–¹æ³•
                            const { results, errors } = parseMultiArrayJSON(text);
                            
                            if (errors.length > 0) {
                                console.warn('JSONè§£æè­¦å‘Š:', errors);
                                alert(`æˆåŠŸè§£æ ${results.length} ä¸ªå…¬å¸\n\n${errors.length > 0 ? 'æ³¨æ„ï¼š\n' + errors.join('\n') : ''}`);
                            } else {
                                console.log(`æˆåŠŸè§£æ ${results.length} ä¸ªå…¬å¸`);
                            }
                            
                            resolve(results);
                        } else {
                            reject(new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file, 'UTF-8');
            });
        }

        // JSONè§£ææ–¹æ³•
        function parseMultiArrayJSON(text) {
            const results = [];
            const errors = [];
            
            // å°†æ–‡æœ¬æŒ‰ ][ åˆ†å‰²æˆå¤šä¸ªæ•°ç»„
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // æŸ¥æ‰¾æ‰€æœ‰çš„JSONæ•°ç»„
            const arrayPattern = /\[\s*\{[\s\S]*?\}\s*\]/g;
            let match;
            let lastEnd = 0;
            
            while ((match = arrayPattern.exec(text)) !== null) {
                try {
                    // å°è¯•è§£ææ‰¾åˆ°çš„æ•°ç»„
                    const arrayStr = match[0];
                    const parsed = JSON.parse(arrayStr);
                    
                    if (Array.isArray(parsed)) {
                        parsed.forEach(item => {
                            results.push({
                                company_name: item.company_name || '',
                                domain: item.website || item.domain || ''
                            });
                        });
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤å¸¸è§é—®é¢˜
                    try {
                        let fixedStr = match[0]
                            .replace(/,\s*}/g, '}')  // ç§»é™¤å¯¹è±¡æœ«å°¾çš„é€—å·
                            .replace(/,\s*]/g, ']'); // ç§»é™¤æ•°ç»„æœ«å°¾çš„é€—å·
                        
                        const parsed = JSON.parse(fixedStr);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(item => {
                                results.push({
                                    company_name: item.company_name || '',
                                    domain: item.website || item.domain || ''
                                });
                            });
                            errors.push(`ä¿®å¤å¹¶è§£æäº†ä¸€ä¸ªæ ¼å¼é”™è¯¯çš„æ•°ç»„`);
                        }
                    } catch (e2) {
                        errors.push(`æ— æ³•è§£ææ•°ç»„: ${e2.message}`);
                    }
                }
                lastEnd = match.index + match[0].length;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ•°ç»„
            const remaining = text.substring(lastEnd).trim();
            if (remaining && remaining.startsWith('[')) {
                // å°è¯•ä¿®å¤å¹¶è§£ææœªå®Œæˆçš„æ•°ç»„
                try {
                    let fixedArray = remaining;
                    
                    // å¦‚æœæ²¡æœ‰ç»“æŸçš„ ]ï¼Œæ·»åŠ å®ƒ
                    if (!fixedArray.includes(']')) {
                        // æ‰¾åˆ°æœ€åä¸€ä¸ª }
                        const lastBrace = fixedArray.lastIndexOf('}');
                        if (lastBrace > -1) {
                            fixedArray = fixedArray.substring(0, lastBrace + 1) + '\n]';
                        }
                    }
                    
                    // ç§»é™¤å°¾éšé€—å·
                    fixedArray = fixedArray
                        .replace(/,\s*}/g, '}')
                        .replace(/,\s*]/g, ']');
                    
                    const parsed = JSON.parse(fixedArray);
                    if (Array.isArray(parsed)) {
                        parsed.forEach(item => {
                            results.push({
                                company_name: item.company_name || '',
                                domain: item.website || item.domain || ''
                            });
                        });
                        errors.push('å¤„ç†äº†æ–‡ä»¶æœ«å°¾çš„æœªå®Œæˆæ•°ç»„');
                    }
                } catch (e) {
                    errors.push(`æ— æ³•è§£ææ–‡ä»¶æœ«å°¾çš„å†…å®¹: ${e.message}`);
                }
            }
            
            return { results, errors };
        }

        // æ˜¾ç¤ºç»“æœï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function displayResults(results, page = 1) {
            const resultsDiv = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');
            
            resultsDiv.style.display = 'block';
            currentPage = page;
            
            // ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ˜¾ç¤ºå…¨éƒ¨æ•°æ®çš„ç»Ÿè®¡ï¼‰
            const totalCompanies = results.length;
            const successfulCompanies = results.filter(r => r.success).length;
            const totalEmails = results.reduce((sum, r) => sum + (r.emails_found || 0), 0);
            
            // è®¡ç®—åˆ†é¡µ
            const totalPages = Math.ceil(totalCompanies / resultsPerPage);
            const startIndex = (page - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const pageResults = results.slice(startIndex, endIndex);
            
            let html = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${totalCompanies}</div>
                        <div class="stat-label">æ€»å…¬å¸æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${successfulCompanies}</div>
                        <div class="stat-label">æˆåŠŸæŸ¥æ‰¾</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalEmails}</div>
                        <div class="stat-label">æ‰¾åˆ°é‚®ç®±</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${successfulCompanies > 0 ? Math.round(successfulCompanies/totalCompanies*100) : 0}%</div>
                        <div class="stat-label">æˆåŠŸç‡</div>
                    </div>
                </div>
            `;
            
            // åˆ†é¡µæ§ä»¶
            if (totalPages > 1) {
                html += createPaginationControls(page, totalPages, totalCompanies);
            }
            
            // å½“å‰é¡µç»“æœ
            html += `<div class="page-results">`;
            pageResults.forEach(result => {
                html += `<div class="result-item">`;
                
                if (result.success) {
                    html += `
                        <div class="company-info">
                            <div>
                                <div class="company-name">${result.company_name}</div>
                                <div class="domain">${result.domain}</div>
                            </div>
                            <div class="email-count">${result.emails_found} ä¸ªé‚®ç®±</div>
                        </div>
                    `;
                    
                    if (result.emails && result.emails.length > 0) {
                        html += '<div class="email-list">';
                        result.emails.forEach(email => {
                            const confidenceClass = email.confidence >= 80 ? 'confidence-high' : 
                                                  email.confidence >= 50 ? 'confidence-medium' : 'confidence-low';
                            
                            // é‚®ç®±ç±»å‹æ˜¾ç¤º
                            const typeDisplay = email.type === 'personal' ? 'ä¸ªäºº' : 
                                              email.type === 'generic' ? 'é€šç”¨' : 
                                              email.type === 'role' ? 'è§’è‰²' : 'æœªçŸ¥';
                            const typeClass = email.type === 'personal' ? 'type-personal' : 
                                            email.type === 'generic' ? 'type-generic' : 'type-unknown';
                            
                            html += `
                                <div class="email-item">
                                    <div>
                                        <div class="email-address">${email.email}</div>
                                        <div class="email-details">
                                            <span class="email-type ${typeClass}">${typeDisplay}</span>
                                            ${email.first_name || email.last_name ? `â€¢ ${email.first_name || ''} ${email.last_name || ''}` : ''}
                                            ${email.ai_generated ? `<span style="color: #667eea; font-size: 0.8em;">(AI${email.is_guess ? 'çŒœæµ‹' : 'æå–'})</span>` : ''}
                                            ${email.position ? `â€¢ ${email.position}` : ''}
                                            ${email.department ? `â€¢ ${email.department}` : ''}
                                        </div>
                                    </div>
                                    <span class="confidence ${confidenceClass}">å¯ä¿¡åº¦: ${email.confidence}%</span>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    
                    if (result.pattern) {
                        html += `<div style="margin-top: 10px; color: #666;">é‚®ç®±æ¨¡å¼: ${result.pattern}</div>`;
                    }
                } else {
                    html += `
                        <div class="company-info">
                            <div>
                                <div class="company-name">${result.company_name}</div>
                                <div class="domain">${result.domain}</div>
                            </div>
                        </div>
                        <div class="error">é”™è¯¯: ${result.error}</div>
                    `;
                }
                
                html += '</div>';
            });
            html += '</div>';
            
            // åº•éƒ¨åˆ†é¡µæ§ä»¶
            if (totalPages > 1) {
                html += createPaginationControls(page, totalPages, totalCompanies);
            }
            
            resultContent.innerHTML = html;
        }

        // åˆ›å»ºåˆ†é¡µæ§ä»¶
        function createPaginationControls(currentPage, totalPages, totalItems) {
            const startItem = (currentPage - 1) * resultsPerPage + 1;
            const endItem = Math.min(currentPage * resultsPerPage, totalItems);
            
            let html = `
                <div class="pagination">
                    <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>é¦–é¡µ</button>
                    <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                    
                    <div class="pagination-info">
                        ç¬¬ ${startItem}-${endItem} é¡¹ï¼Œå…± ${totalItems} é¡¹ (ç¬¬ ${currentPage}/${totalPages} é¡µ)
                    </div>
                    
                    <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                    <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é¡µ</button>
                </div>
            `;
            
            return html;
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(page) {
            if (page < 1 || page > Math.ceil(currentResults.length / resultsPerPage)) {
                return;
            }
            displayResults(currentResults, page);
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸé¡¶éƒ¨
            document.getElementById('results').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // ä¸‹è½½Instantly AIæ ¼å¼çš„CSV
        async function downloadInstantlyCSV() {
            if (currentResults.length === 0) return;
            
            try {
                // æ·»åŠ BOMä»¥æ”¯æŒExcelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡ï¼ˆUTF-8ç¼–ç ï¼‰
                const BOM = '\uFEFF';
                let csv = BOM + 'Email,First Name,Last Name,Company Name,Phone,Job Title,Country,Email Type,AI Generated\n';
                
                for (const result of currentResults) {
                    if (result.success && result.emails && result.emails.length > 0) {
                        // ç›´æ¥ä½¿ç”¨å·²ç»å¤„ç†è¿‡çš„é‚®ç®±æ•°æ®ï¼ˆåœ¨searchSingleæˆ–searchBatchæ—¶å·²ç»å¤„ç†è¿‡ï¼‰
                        for (const email of result.emails) {
                            // å¤„ç†First Nameï¼šå¦‚æœæ˜¯é€šç”¨é‚®ç®±ï¼Œä½¿ç”¨å…¬å¸å+Team
                            let firstName = email.first_name || '';
                            if ((email.type === 'generic' || email.type === 'role') && !firstName) {
                                // ç§»é™¤å…¬å¸åç§°åç¼€
                                const cleanCompanyName = cleanupCompanyName(result.company_name);
                                firstName = cleanCompanyName ? `${cleanCompanyName} Team` : '';
                            }
                            
                            // æŒ‰ç…§Instantly AIè¦æ±‚çš„å­—æ®µé¡ºåºï¼ŒåŠ ä¸Šè‡ªå®šä¹‰å­—æ®µ
                            const row = [
                                email.email || '',                    // Email (å¿…å¡«)
                                firstName,                            // First Name (å¤„ç†åçš„)
                                email.last_name || '',                // Last Name
                                result.company_name || '',            // Company Name
                                '',                                   // Phone (ç•™ç©º)
                                email.position || '',                 // Job Title
                                '',                                   // Country (ç•™ç©º)
                                email.type || 'unknown',              // Email Type (è‡ªå®šä¹‰å­—æ®µ)
                                email.ai_generated ? 'Yes' : 'No'     // AI Generated (æ ‡è®°æ˜¯å¦ä¸ºAIç”Ÿæˆ)
                            ];
                            
                            // è½¬ä¹‰å¤„ç†
                            const escapedRow = row.map(field => {
                                const str = String(field);
                                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                                    return `"${str.replace(/"/g, '""')}"`;
                                }
                                return str;  // Instantlyå¯èƒ½ä¸éœ€è¦æ‰€æœ‰å­—æ®µéƒ½åŠ å¼•å·
                            });
                            
                            csv += escapedRow.join(',') + '\n';
                        }
                    }
                    // æ³¨æ„ï¼šInstantlyæ ¼å¼ä¸­ï¼Œæ²¡æœ‰é‚®ç®±çš„å…¬å¸ä¸åŒ…å«åœ¨CSVä¸­
                }
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                downloadFile(csv, `instantly_contacts_${timestamp}.csv`, 'text/csv;charset=utf-8');
                
                // æç¤ºç”¨æˆ·
                const enableGuessing = document.getElementById('enableNameGuessing').checked;
                const openaiKey = localStorage.getItem('openaiApiKey');
                
                let alertMessage = 'å·²ä¸‹è½½Instantly AIæ ¼å¼çš„CSVæ–‡ä»¶\n\næ³¨æ„ï¼š\n- åªåŒ…å«æœ‰é‚®ç®±çš„è”ç³»äºº\n- Phoneå’ŒCountryå­—æ®µä¸ºç©ºï¼Œéœ€è¦æ—¶è¯·æ‰‹åŠ¨è¡¥å……\n- Email Typeå­—æ®µæ ‡è¯†é‚®ç®±ç±»å‹ï¼ˆpersonal/genericï¼‰\n- é€šç”¨é‚®ç®±çš„First Nameè‡ªåŠ¨è®¾ä¸º"å…¬å¸å Team"';
                
                if (enableGuessing && openaiKey) {
                    alertMessage += '\n- AI Generatedå­—æ®µæ ‡è¯†åå­—æ˜¯å¦ç”±AIç”Ÿæˆ';
                }
                
                alert(alertMessage);
                
            } catch (error) {
                console.error('Error downloading CSV:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¸‹è½½æ²¡æœ‰æ‰¾åˆ°é‚®ç®±çš„å…¬å¸CSV
        function downloadFailedCompaniesCSV() {
            if (currentResults.length === 0) return;
            
            // ç­›é€‰å‡ºæ²¡æœ‰æ‰¾åˆ°é‚®ç®±çš„å…¬å¸
            const failedCompanies = currentResults.filter(result => 
                !result.success || !result.emails || result.emails.length === 0
            );
            
            if (failedCompanies.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœªæˆåŠŸè·å–é‚®ç®±çš„å…¬å¸');
                return;
            }
            
            const BOM = '\uFEFF';
            let csv = BOM + 'Company Name,Domain,Error Message,Status\n';
            
            failedCompanies.forEach(result => {
                const row = [
                    result.company_name || '',
                    result.domain || '',
                    result.error || (result.success ? 'æœªæ‰¾åˆ°é‚®ç®±' : 'æŸ¥æ‰¾å¤±è´¥'),
                    result.success ? 'æˆåŠŸä½†æ— é‚®ç®±' : 'æŸ¥æ‰¾å¤±è´¥'
                ];
                
                const escapedRow = row.map(field => {
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return `"${str}"`;
                });
                
                csv += escapedRow.join(',') + '\n';
            });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            downloadFile(csv, `failed_companies_${timestamp}.csv`, 'text/csv;charset=utf-8');
            
            alert(`å·²ä¸‹è½½ ${failedCompanies.length} ä¸ªæœªæ‰¾åˆ°é‚®ç®±çš„å…¬å¸ä¿¡æ¯`);
        }


        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            currentResults = [];
            currentPage = 1; // é‡ç½®åˆ†é¡µ
            document.getElementById('results').style.display = 'none';
            document.getElementById('singleDomain').value = '';
            document.getElementById('companyName').value = '';
            document.getElementById('batchInput').value = '';
            document.getElementById('csvFile').value = '';
        }

        // æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ›´æ–°åŠ è½½æ–‡å­—
        function updateLoadingText(text) {
            const loading = document.getElementById('loading');
            const p = loading.querySelector('p');
            if (p) {
                p.textContent = text;
            }
        }

        // å»¶è¿Ÿå‡½æ•°
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // APIå¯†é’¥ç®¡ç†åŠŸèƒ½
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showApiStatus('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            localStorage.setItem('hunterApiKey', apiKey);
            showApiStatus('APIå¯†é’¥å·²ä¿å­˜', 'success');
        }

        function clearApiKey() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„APIå¯†é’¥å—ï¼Ÿ')) {
                localStorage.removeItem('hunterApiKey');
                document.getElementById('apiKey').value = '';
                showApiStatus('APIå¯†é’¥å·²æ¸…é™¤', 'success');
            }
        }

        async function testApiKey() {
            const apiKey = getApiKey();
            if (!apiKey) return;
            
            showApiStatus('æµ‹è¯•è¿æ¥ä¸­...', 'testing');
            
            try {
                await updateApiQuota(apiKey);
            } catch (error) {
                showApiStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }
        
        // æ›´æ–°APIé…é¢ä¿¡æ¯
        async function updateApiQuota(apiKey) {
            try {
                const accountUrl = `https://api.hunter.io/v2/account?api_key=${apiKey}`;
                const accountResponse = await fetch(accountUrl);
                const accountData = await accountResponse.json();
                
                if (accountResponse.ok) {
                    const remaining = accountData.data.requests.searches.available;
                    const used = accountData.data.requests.searches.used;
                    const total = remaining + used;
                    
                    showApiStatus(`è¿æ¥æˆåŠŸï¼å‰©ä½™æŸ¥è¯¢æ¬¡æ•°: ${remaining} (å·²ä½¿ç”¨: ${used}/${total})`, 'success');
                    
                    // ä¿å­˜åˆ°å…¨å±€å˜é‡
                    window.hunterApiQuota = { remaining, used, total };
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜æ˜¾ç¤ºé…é¢
                    updateQuotaDisplay(remaining, used, total);
                    
                    AppLogger.info('APIé…é¢æ›´æ–°', { remaining, used, total });
                    
                    return { remaining, used, total };
                } else {
                    showApiStatus('è¿æ¥æˆåŠŸï¼', 'success');
                    return null;
                }
            } catch (error) {
                console.error('æ›´æ–°é…é¢å¤±è´¥:', error);
                return null;
            }
        }
        
        // æ›´æ–°é¡µé¢ä¸Šçš„é…é¢æ˜¾ç¤º
        function updateQuotaDisplay(remaining, used, total) {
            // åœ¨Hunter APIå¯†é’¥åŒºåŸŸæ·»åŠ é…é¢æ˜¾ç¤º
            let quotaDisplay = document.getElementById('quotaDisplay');
            if (!quotaDisplay) {
                quotaDisplay = document.createElement('div');
                quotaDisplay.id = 'quotaDisplay';
                quotaDisplay.style.cssText = 'margin-top: 10px; padding: 8px; background: #e6f2ff; border-radius: 5px; font-size: 14px;';
                
                const apiKeySection = document.querySelector('.api-card:first-child .form-group');
                apiKeySection.appendChild(quotaDisplay);
            }
            
            const percentage = ((total - remaining) / total * 100).toFixed(1);
            const now = new Date().toLocaleTimeString();
            quotaDisplay.innerHTML = `
                <strong>ğŸ“Š APIä½¿ç”¨æƒ…å†µ</strong> <small style="color: #666;">(${now}æ›´æ–°)</small><br>
                å‰©ä½™: <span style="color: #22543d; font-weight: bold;">${remaining}</span> | 
                å·²ä½¿ç”¨: <span style="color: #742a2a;">${used}</span> | 
                æ€»è®¡: ${total} | 
                ä½¿ç”¨ç‡: <span style="color: ${percentage > 80 ? '#742a2a' : '#22543d'};">${percentage}%</span>
            `;
            
            // å¦‚æœä½¿ç”¨ç‡è¿‡é«˜ï¼Œæ˜¾ç¤ºè­¦å‘Š
            if (percentage > 90) {
                quotaDisplay.style.background = '#fed7d7';
                quotaDisplay.style.border = '1px solid #e53e3e';
            } else if (percentage > 80) {
                quotaDisplay.style.background = '#fef3c7';
                quotaDisplay.style.border = '1px solid #f59e0b';
            } else {
                quotaDisplay.style.background = '#e6f2ff';
                quotaDisplay.style.border = 'none';
            }
        }

        function showApiStatus(message, type) {
            const statusElement = document.getElementById('apiStatus');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            
            // ä¿æŒæ¶ˆæ¯æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨æ¸…é™¤
        }

        // æ¸…ç†å…¬å¸åç§°ï¼Œç§»é™¤å¸¸è§åç¼€
        function cleanupCompanyName(companyName) {
            if (!companyName) return '';
            
            // å¸¸è§çš„å…¬å¸åç¼€
            const suffixes = [
                // è‹±æ–‡åç¼€
                ', LLC', ' LLC', ', INC', ' INC', ', Inc.', ' Inc.', ', Inc', ' Inc',
                ', CORP', ' CORP', ', Corp.', ' Corp.', ', Corp', ' Corp',
                ', LTD', ' LTD', ', Ltd.', ' Ltd.', ', Ltd', ' Ltd',
                ', CO', ' CO', ', Co.', ' Co.', ', Co', ' Co',
                ', COMPANY', ' COMPANY', ', Company', ' Company',
                ', CORPORATION', ' CORPORATION', ', Corporation', ' Corporation',
                ', INCORPORATED', ' INCORPORATED', ', Incorporated', ' Incorporated',
                ', LIMITED', ' LIMITED', ', Limited', ' Limited',
                ', LP', ' LP', ', L.P.', ' L.P.',
                ', LLP', ' LLP', ', L.L.P.', ' L.L.P.',
                ', PC', ' PC', ', P.C.', ' P.C.',
                ', PA', ' PA', ', P.A.', ' P.A.',
                ', PLLC', ' PLLC', ', P.L.L.C.', ' P.L.L.C.',
                ', SERIES', ' SERIES', ', Series', ' Series',
                // ä¸­æ–‡åç¼€
                'æœ‰é™å…¬å¸', 'è‚¡ä»½æœ‰é™å…¬å¸', 'æœ‰é™è´£ä»»å…¬å¸', 'é›†å›¢', 'å…¬å¸'
            ];
            
            let cleanName = companyName.trim();
            
            // ç§»é™¤åç¼€
            for (const suffix of suffixes) {
                if (cleanName.endsWith(suffix)) {
                    cleanName = cleanName.substring(0, cleanName.length - suffix.length).trim();
                    break; // åªç§»é™¤ä¸€ä¸ªåç¼€
                }
            }
            
            // ç§»é™¤å¤šä½™çš„æ ‡ç‚¹ç¬¦å·
            cleanName = cleanName.replace(/[,.]$/, '').trim();
            
            return cleanName;
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Claude APIç›¸å…³å‡½æ•°
        function toggleClaudeKeyVisibility() {
            const claudeKeyInput = document.getElementById('claudeKey');
            const toggleIcon = document.getElementById('toggleClaudeIcon');
            
            if (claudeKeyInput.type === 'password') {
                claudeKeyInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                claudeKeyInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function saveClaudeKey() {
            const claudeKey = document.getElementById('claudeKey').value.trim();
            if (!claudeKey) {
                showClaudeStatus('è¯·è¾“å…¥Claude APIå¯†é’¥', 'error');
                return;
            }
            
            localStorage.setItem('claudeApiKey', claudeKey);
            showClaudeStatus('Claude APIå¯†é’¥å·²ä¿å­˜', 'success');
        }

        function clearClaudeKey() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„Claude APIå¯†é’¥å—ï¼Ÿ')) {
                localStorage.removeItem('claudeApiKey');
                document.getElementById('claudeKey').value = '';
                showClaudeStatus('Claude APIå¯†é’¥å·²æ¸…é™¤', 'success');
            }
        }

        async function testClaudeKey() {
            const claudeKey = document.getElementById('claudeKey').value.trim();
            if (!claudeKey) {
                showClaudeStatus('è¯·è¾“å…¥Claude APIå¯†é’¥', 'error');
                return;
            }
            
            showClaudeStatus('æµ‹è¯•è¿æ¥ä¸­...', 'testing');
            
            try {
                AppLogger.info('æµ‹è¯•Claude APIè¿æ¥', { proxyUrl: CLAUDE_PROXY_URL });
                const response = await fetch(`${CLAUDE_PROXY_URL}/api/claude/test`, {
                    method: 'POST',
                    headers: {
                        'x-api-key': claudeKey,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showClaudeStatus('è¿æ¥æˆåŠŸï¼APIå¯†é’¥æœ‰æ•ˆ', 'success');
                    } else {
                        showClaudeStatus(data.error || 'è¿æ¥å¤±è´¥', 'error');
                    }
                } else if (response.status === 401) {
                    showClaudeStatus('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥', 'error');
                } else {
                    const errorData = await response.json();
                    showClaudeStatus(errorData.error || 'è¿æ¥å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Claude API test error:', error);
                if (error.message.includes('Failed to fetch')) {
                    showClaudeStatus(`æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨ã€‚è¯·ç¡®ä¿ä»£ç†æœåŠ¡å™¨æ­£åœ¨è¿è¡Œäº ${CLAUDE_PROXY_URL}`, 'error');
                } else {
                    showClaudeStatus(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                }
            }
        }

        function showClaudeStatus(message, type) {
            const statusElement = document.getElementById('claudeStatus');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            
            // ä¿æŒæ¶ˆæ¯æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨æ¸…é™¤
        }

        // ChatGPT APIç›¸å…³å‡½æ•°
        function toggleOpenAIKeyVisibility() {
            const openaiKeyInput = document.getElementById('openaiKey');
            const toggleIcon = document.getElementById('toggleOpenAIIcon');
            
            if (openaiKeyInput.type === 'password') {
                openaiKeyInput.type = 'text';
                toggleIcon.textContent = 'ğŸ™ˆ';
            } else {
                openaiKeyInput.type = 'password';
                toggleIcon.textContent = 'ğŸ‘ï¸';
            }
        }

        function saveOpenAIKey() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            if (!openaiKey) {
                showOpenAIStatus('è¯·è¾“å…¥OpenAI APIå¯†é’¥', 'error');
                return;
            }
            
            localStorage.setItem('openaiApiKey', openaiKey);
            showOpenAIStatus('OpenAI APIå¯†é’¥å·²ä¿å­˜', 'success');
        }

        function clearOpenAIKey() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„OpenAI APIå¯†é’¥å—ï¼Ÿ')) {
                localStorage.removeItem('openaiApiKey');
                document.getElementById('openaiKey').value = '';
                showOpenAIStatus('OpenAI APIå¯†é’¥å·²æ¸…é™¤', 'success');
            }
        }

        async function testOpenAIKey() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            if (!openaiKey) {
                showOpenAIStatus('è¯·è¾“å…¥OpenAI APIå¯†é’¥', 'error');
                return;
            }
            
            showOpenAIStatus('æµ‹è¯•è¿æ¥ä¸­...', 'testing');
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${openaiKey}`
                    }
                });
                
                if (response.ok) {
                    showOpenAIStatus('è¿æ¥æˆåŠŸï¼APIå¯†é’¥æœ‰æ•ˆ', 'success');
                } else if (response.status === 401) {
                    showOpenAIStatus('APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥', 'error');
                } else {
                    showOpenAIStatus('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                }
            } catch (error) {
                showOpenAIStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        function showOpenAIStatus(message, type) {
            const statusElement = document.getElementById('openaiStatus');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            
            // ä¿æŒæ¶ˆæ¯æ˜¾ç¤ºï¼Œä¸è‡ªåŠ¨æ¸…é™¤
        }

        // æ‰¹é‡å¤„ç†é‚®ç®±åå­—çŒœæµ‹
        async function batchProcessEmailsWithAI(emailBatch) {
            if (emailBatch.length === 0) {
                return new Map();
            }
            
            // æ£€æŸ¥ä½¿ç”¨å“ªä¸ªAIæœåŠ¡
            const useOpenAI = document.getElementById('useOpenAI').checked;
            
            if (useOpenAI) {
                return batchProcessWithOpenAI(emailBatch);
            } else {
                return batchProcessWithClaude(emailBatch);
            }
        }
        
        // ä½¿ç”¨OpenAIæ‰¹é‡å¤„ç†
        async function batchProcessWithOpenAI(emailBatch) {
            const openaiKey = localStorage.getItem('openaiApiKey');
            if (!openaiKey) {
                return new Map();
            }

            try {
                // æ„å»ºæ‰¹é‡å¤„ç†çš„prompt
                const emailList = emailBatch.map(item => {
                    const domain = item.email.split('@')[1];
                    const domainName = domain.split('.')[0].toUpperCase();
                    const companyDisplayName = item.companyName || domainName;
                    return `${item.email} (å…¬å¸: ${companyDisplayName})`;
                }).join('\n');

                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„é‚®ç®±åœ°å€åˆ†æå™¨ã€‚è¯·åˆ†æä»¥ä¸‹é‚®ç®±åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªé‚®ç®±ç”Ÿæˆåˆé€‚çš„ç§°å‘¼ã€‚

é‡è¦è§„åˆ™ï¼š
1. åªèƒ½ä»é‚®ç®±åœ°å€æœ¬èº«æå–ä¿¡æ¯ï¼Œç»ä¸èƒ½å‡­ç©ºçŒœæµ‹æˆ–æ·»åŠ ä¸å­˜åœ¨çš„å§“æ°
2. å¦‚æœé‚®ç®±åŒ…å«æ˜æ˜¾çš„åå­—å’Œå§“æ°ï¼ˆå¦‚john.doeã€ashley.carnesï¼‰ï¼Œæ‰æå–å®Œæ•´çš„åå­—å’Œå§“æ°
3. å¦‚æœé‚®ç®±åªæœ‰åå­—ï¼ˆå¦‚john@ï¼‰ï¼Œåªä½¿ç”¨åå­—ï¼Œå§“æ°ç•™ç©º
4. å¦‚æœæ˜¯å•ä¸ªé¦–å­—æ¯+å§“æ°ï¼ˆå¦‚acarnesï¼‰ï¼Œä½¿ç”¨é¦–å­—æ¯å¤§å†™ï¼ˆå¦‚A. Carnesï¼‰
5. å¦‚æœé‚®ç®±å‰ç¼€ä¸åƒäººåï¼ˆå¦‚infoã€supportï¼‰ï¼Œä½¿ç”¨"å…¬å¸å Team"

é‚®ç®±åˆ—è¡¨ï¼š
${emailList}

è¯·è¿”å›JSONæ•°ç»„æ ¼å¼ï¼Œæ¯ä¸ªé‚®ç®±å¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼š
[
  {
    "email": "åŸå§‹é‚®ç®±",
    "first_name": "åå­—æˆ–å›¢é˜Ÿå",
    "last_name": "å§“æ°ï¼ˆå¦‚æœæœ‰ï¼‰",
    "is_team": true/false,
    "extraction_type": "extracted/partial/team"
  }
]

é‡è¦ï¼šç›´æ¥è¿”å›çº¯JSONæ•°ç»„ï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ã€‚`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„é‚®ç®±åœ°å€åˆ†æå™¨ã€‚ä½ åªèƒ½ä»é‚®ç®±åœ°å€ä¸­æå–å®é™…å­˜åœ¨çš„ä¿¡æ¯ï¼Œç»ä¸èƒ½å‡­ç©ºåˆ›é€ æˆ–çŒœæµ‹ä¸å­˜åœ¨çš„å†…å®¹ã€‚å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.2,
                        max_tokens: 1000
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content.trim();
                    
                    try {
                        // å¤„ç†å¯èƒ½çš„markdownä»£ç å—åŒ…è£¹
                        let cleanContent = content;
                        if (content.includes('```')) {
                            cleanContent = content.replace(/```json?\n?/g, '').replace(/```\n?/g, '').trim();
                        }
                        
                        const results = JSON.parse(cleanContent);
                        
                        // å°†ç»“æœè½¬æ¢ä¸ºMapä¾¿äºæŸ¥æ‰¾
                        const resultMap = new Map();
                        results.forEach(result => {
                            resultMap.set(result.email, {
                                first_name: result.first_name || '',
                                last_name: result.last_name || '',
                                is_guess: result.extraction_type === 'partial',
                                is_team: result.is_team || false
                            });
                        });
                        
                        return resultMap;
                    } catch (parseError) {
                        console.error('Error parsing batch AI response:', parseError);
                        return new Map();
                    }
                }
            } catch (error) {
                console.error('Error in batch processing:', error);
            }

            return new Map();
        }
        
        // ä½¿ç”¨Claudeæ‰¹é‡å¤„ç†
        async function batchProcessWithClaude(emailBatch) {
            const claudeKey = localStorage.getItem('claudeApiKey');
            if (!claudeKey) {
                return new Map();
            }

            try {
                // æ„å»ºæ‰¹é‡å¤„ç†çš„prompt
                const emailList = emailBatch.map(item => {
                    const domain = item.email.split('@')[1];
                    const domainName = domain.split('.')[0].toUpperCase();
                    const companyDisplayName = item.companyName || domainName;
                    return `${item.email} (å…¬å¸: ${companyDisplayName})`;
                }).join('\n');

                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„é‚®ç®±åœ°å€åˆ†æå™¨ã€‚è¯·åˆ†æä»¥ä¸‹é‚®ç®±åˆ—è¡¨ï¼Œä¸ºæ¯ä¸ªé‚®ç®±ç”Ÿæˆåˆé€‚çš„ç§°å‘¼ã€‚

é‡è¦è§„åˆ™ï¼š
1. åªèƒ½ä»é‚®ç®±åœ°å€æœ¬èº«æå–ä¿¡æ¯ï¼Œç»ä¸èƒ½å‡­ç©ºçŒœæµ‹æˆ–æ·»åŠ ä¸å­˜åœ¨çš„å§“æ°
2. å¦‚æœé‚®ç®±åŒ…å«æ˜æ˜¾çš„åå­—å’Œå§“æ°ï¼ˆå¦‚john.doeã€ashley.carnesï¼‰ï¼Œæ‰æå–å®Œæ•´çš„åå­—å’Œå§“æ°
3. å¦‚æœé‚®ç®±åªæœ‰åå­—ï¼ˆå¦‚john@ï¼‰ï¼Œåªä½¿ç”¨åå­—ï¼Œå§“æ°ç•™ç©º
4. å¦‚æœæ˜¯å•ä¸ªé¦–å­—æ¯+å§“æ°ï¼ˆå¦‚acarnesï¼‰ï¼Œä½¿ç”¨é¦–å­—æ¯å¤§å†™ï¼ˆå¦‚A. Carnesï¼‰
5. å¦‚æœé‚®ç®±å‰ç¼€ä¸åƒäººåï¼ˆå¦‚infoã€supportï¼‰ï¼Œä½¿ç”¨"å…¬å¸å Team"

é‚®ç®±åˆ—è¡¨ï¼š
${emailList}

è¯·è¿”å›JSONæ•°ç»„æ ¼å¼ï¼Œæ¯ä¸ªé‚®ç®±å¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼š
[
  {
    "email": "åŸå§‹é‚®ç®±",
    "first_name": "åå­—æˆ–å›¢é˜Ÿå",
    "last_name": "å§“æ°ï¼ˆå¦‚æœæœ‰ï¼‰",
    "is_team": true/false,
    "extraction_type": "extracted/partial/team"
  }
]

é‡è¦ï¼šç›´æ¥è¿”å›çº¯JSONæ•°ç»„ï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ã€‚`;

                const response = await fetch(`${CLAUDE_PROXY_URL}/api/claude/messages`, {
                    method: 'POST',
                    headers: {
                        'x-api-key': claudeKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-haiku-20241022',
                        max_tokens: 2500,
                        temperature: 0.2,
                        system: 'ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„é‚®ç®±åœ°å€åˆ†æå™¨ã€‚ä½ åªèƒ½ä»é‚®ç®±åœ°å€ä¸­æå–å®é™…å­˜åœ¨çš„ä¿¡æ¯ï¼Œç»ä¸èƒ½å‡­ç©ºåˆ›é€ æˆ–çŒœæµ‹ä¸å­˜åœ¨çš„å†…å®¹ã€‚å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„JSONæ•°ç»„æ ¼å¼ã€‚',
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.content[0].text.trim();
                    
                    try {
                        // å¤„ç†å¯èƒ½çš„markdownä»£ç å—åŒ…è£¹
                        let cleanContent = content;
                        if (content.includes('```')) {
                            cleanContent = content.replace(/```json?\n?/g, '').replace(/```\n?/g, '').trim();
                        }
                        
                        const results = JSON.parse(cleanContent);
                        
                        // å°†ç»“æœè½¬æ¢ä¸ºMapä¾¿äºæŸ¥æ‰¾
                        const resultMap = new Map();
                        results.forEach(result => {
                            resultMap.set(result.email, {
                                first_name: result.first_name || '',
                                last_name: result.last_name || '',
                                is_guess: result.extraction_type === 'partial',
                                is_team: result.is_team || false
                            });
                        });
                        
                        return resultMap;
                    } catch (parseError) {
                        console.error('Error parsing Claude response:', parseError);
                        return new Map();
                    }
                } else {
                    console.error('Claude API response not ok:', response.status);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                }
            } catch (error) {
                console.error('Error in Claude batch processing:', error);
                if (error.message.includes('Failed to fetch')) {
                    console.error('CORS error: Cannot directly call Claude API from browser');
                }
            }

            return new Map();
        }
        
        // ä½¿ç”¨ChatGPTçŒœæµ‹åå­—
        async function guessNameFromEmail(email, companyName) {
            // æ£€æŸ¥ç¼“å­˜
            const cacheKey = `${email}|${companyName || ''}`;
            if (nameGuessCache.has(cacheKey)) {
                return nameGuessCache.get(cacheKey);
            }

            const openaiKey = localStorage.getItem('openaiApiKey');
            if (!openaiKey) {
                return { first_name: '', last_name: '' };
            }

            try {
                // æå–åŸŸåä½œä¸ºå…¬å¸åç§°
                const domain = email.split('@')[1];
                const domainName = domain.split('.')[0].toUpperCase();
                const companyDisplayName = companyName || domainName;
                
                const prompt = `ä½ æ˜¯ä¸€ä¸ªæ•°æ®æ¸…æ´—å’Œé‚®ä»¶å†™ä½œåŠ©ç†ï¼Œè¯·æ ¹æ®ä¸‹æ–¹æä¾›çš„é‚®ç®±åœ°å€ï¼Œæ™ºèƒ½æå–æˆ–ç”Ÿæˆé‚®ä»¶ç§°å‘¼ã€‚

é‡è¦è§„åˆ™ï¼š
1. åªèƒ½ä»é‚®ç®±åœ°å€æœ¬èº«æå–ä¿¡æ¯ï¼Œç»ä¸èƒ½å‡­ç©ºçŒœæµ‹æˆ–æ·»åŠ ä¸å­˜åœ¨çš„å§“æ°
2. å¦‚æœé‚®ç®±åŒ…å«æ˜æ˜¾çš„åå­—å’Œå§“æ°ï¼ˆå¦‚john.doeã€ashley.carnesã€john_smithï¼‰ï¼Œæ‰æå–å®Œæ•´çš„åå­—å’Œå§“æ°
3. å¦‚æœé‚®ç®±åªæœ‰åå­—ï¼ˆå¦‚john@ã€mary@ï¼‰ï¼Œåªä½¿ç”¨åå­—ï¼Œå§“æ°ç•™ç©º
4. å¦‚æœæ˜¯å•ä¸ªé¦–å­—æ¯+å§“æ°ï¼ˆå¦‚acarnesã€jsmithï¼‰ï¼Œä½¿ç”¨é¦–å­—æ¯å¤§å†™ï¼ˆå¦‚A. Carnesï¼‰
5. å¦‚æœé‚®ç®±å‰ç¼€ä¸åƒäººåï¼ˆå¦‚infoã€supportã€oquxiã€salesç­‰ï¼‰ï¼Œä½¿ç”¨"å…¬å¸å Team"

æ•°æ®ï¼š
- å…¬å¸å: ${companyDisplayName}
- é‚®ç®±: ${email}

è¯·åˆ†æåè¿”å›JSONæ ¼å¼ï¼š
{
    "greeting": "ç§°å‘¼",
    "first_name": "åå­—æˆ–å›¢é˜Ÿå",
    "last_name": "å§“æ°ï¼ˆå¦‚æœæœ‰ï¼‰",
    "is_team": true/false,
    "extraction_type": "extracted/partial/team"
}

ä¾‹å­ï¼š
- john@company.com â†’ {"greeting": "Dear John,", "first_name": "John", "last_name": "", "is_team": false, "extraction_type": "partial"}
- john.smith@company.com â†’ {"greeting": "Dear John Smith,", "first_name": "John", "last_name": "Smith", "is_team": false, "extraction_type": "extracted"}
- acarnes@company.com â†’ {"greeting": "Dear A. Carnes,", "first_name": "A.", "last_name": "Carnes", "is_team": false, "extraction_type": "extracted"}
- info@company.com â†’ {"greeting": "Dear ${companyDisplayName} Team,", "first_name": "${companyDisplayName} Team", "last_name": "", "is_team": true, "extraction_type": "team"}

é‡è¦ï¼šç›´æ¥è¿”å›çº¯JSONï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ã€‚`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4-turbo-preview',  // ä½¿ç”¨GPT-4 Turbo
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„é‚®ç®±åœ°å€åˆ†æå™¨ã€‚ä½ åªèƒ½ä»é‚®ç®±åœ°å€ä¸­æå–å®é™…å­˜åœ¨çš„ä¿¡æ¯ï¼Œç»ä¸èƒ½å‡­ç©ºåˆ›é€ æˆ–çŒœæµ‹ä¸å­˜åœ¨çš„å†…å®¹ã€‚å¦‚æœé‚®ç®±åªæœ‰åå­—ï¼ˆå¦‚john@ï¼‰ï¼Œå°±åªè¿”å›åå­—ã€‚å§‹ç»ˆè¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.2,  // é™ä½æ¸©åº¦ä½¿è¾“å‡ºæ›´ç¨³å®š
                        max_tokens: 150
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content.trim();
                    
                    try {
                        // å¤„ç†å¯èƒ½çš„markdownä»£ç å—åŒ…è£¹
                        let cleanContent = content;
                        if (content.includes('```json')) {
                            cleanContent = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        } else if (content.includes('```')) {
                            cleanContent = content.replace(/```\n?/g, '').trim();
                        }
                        
                        const result = JSON.parse(cleanContent);
                        
                        // ç¼“å­˜ç»“æœ
                        nameGuessCache.set(cacheKey, result);
                        
                        // é€‚é…æ–°çš„è¿”å›æ ¼å¼
                        const adaptedResult = {
                            first_name: result.first_name || '',
                            last_name: result.last_name || '',
                            is_guess: !result.is_team && result.first_name && result.first_name.length <= 2,
                            is_team: result.is_team || false,
                            greeting: result.greeting || ''
                        };
                        
                        return adaptedResult;
                    } catch (parseError) {
                        console.error('Error parsing AI response:', parseError);
                        console.error('Original content:', content);
                        return { first_name: '', last_name: '', is_guess: false };
                    }
                }
            } catch (error) {
                console.error('Error guessing name:', error);
            }

            return { first_name: '', last_name: '', is_guess: false };
        }

        // å¤„ç†é‚®ç®±åˆ—è¡¨ï¼Œæ·»åŠ AIçŒœæµ‹çš„åå­—
        async function processEmailsWithAI(emails, companyName) {
            const enableGuessing = document.getElementById('enableNameGuessing').checked;
            if (!enableGuessing) {
                return emails;
            }

            const openaiKey = localStorage.getItem('openaiApiKey');
            if (!openaiKey) {
                return emails;
            }

            // è®¡ç®—éœ€è¦å¤„ç†çš„é‚®ç®±æ•°é‡ï¼ˆåŒ…æ‹¬personalå’Œgenericç±»å‹ï¼‰
            const emailsNeedingProcessing = emails.filter(e => 
                (e.type === 'personal' || e.type === 'generic') && !e.first_name
            );
            if (emailsNeedingProcessing.length === 0) {
                return emails;
            }

            // å¤„ç†æ¯ä¸ªé‚®ç®±
            const processedEmails = [];
            let processedCount = 0;
            
            for (const email of emails) {
                let processedEmail = { ...email };
                
                // å¤„ç†personalå’Œgenericç±»å‹ä¸”æ²¡æœ‰first_nameçš„é‚®ç®±
                if ((email.type === 'personal' || email.type === 'generic') && !email.first_name) {
                    processedCount++;
                    updateLoadingText(`æ­£åœ¨ä½¿ç”¨AIç”Ÿæˆç§°å‘¼ (${processedCount}/${emailsNeedingProcessing.length})...`);
                    
                    const guessedResult = await guessNameFromEmail(email.email, companyName);
                    if (guessedResult && (guessedResult.first_name || guessedResult.last_name)) {
                        // å¦‚æœAIçŒœæµ‹äº†åå­—ï¼Œæ›´æ–°é‚®ç®±ä¿¡æ¯
                        if (guessedResult.first_name) {
                            processedEmail.first_name = guessedResult.first_name;
                        }
                        if (guessedResult.last_name && !email.last_name) {
                            processedEmail.last_name = guessedResult.last_name;
                        }
                        processedEmail.ai_generated = true; // æ ‡è®°ä¸ºAIç”Ÿæˆ
                        processedEmail.is_guess = guessedResult.is_guess; // æ ‡è®°æ˜¯å¦ä¸ºçŒœæµ‹
                    }
                }
                
                processedEmails.push(processedEmail);
            }

            return processedEmails;
        }

        // é€šç”¨çš„å±•å¼€/æ”¶èµ·åŠŸèƒ½
        function toggleSection(sectionName) {
            const section = document.getElementById(sectionName + 'Section');
            const arrow = document.getElementById(sectionName + 'Arrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }
        
        // æ—¥å¿—é¢æ¿ç›¸å…³åŠŸèƒ½
        function toggleLogPanel() {
            const panel = document.getElementById('logPanel');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                refreshLogDisplay();
            } else {
                panel.style.display = 'none';
            }
        }
        
        function refreshLogDisplay() {
            const logContent = document.getElementById('logContent');
            const logs = AppLogger.getLogs();
            
            if (logs.length === 0) {
                logContent.innerHTML = '<p style="color: #666;">æš‚æ— æ—¥å¿—è®°å½•</p>';
                return;
            }
            
            // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨ä¸Šé¢
            const html = logs.reverse().map(log => {
                const levelColor = {
                    'ERROR': '#dc3545',
                    'WARN': '#ffc107',
                    'INFO': '#28a745',
                    'DEBUG': '#6c757d'
                }[log.level] || '#333';
                
                return `<div style="margin-bottom: 8px; border-left: 3px solid ${levelColor}; padding-left: 8px;">
                    <span style="color: #666;">${new Date(log.timestamp).toLocaleString()}</span>
                    <span style="color: ${levelColor}; font-weight: bold;">[${log.level}]</span>
                    <span>${log.message}</span>
                    ${Object.keys(log.data).length > 0 ? `<br><span style="color: #666; font-size: 11px;">${JSON.stringify(log.data)}</span>` : ''}
                </div>`;
            }).join('');
            
            logContent.innerHTML = html;
        }
        
        // æ˜¾ç¤ºä»£ç†æœåŠ¡å™¨è®¾ç½®è¯´æ˜
        function showProxySetup() {
            alert(`Claude API ä»£ç†æœåŠ¡å™¨è®¾ç½®è¯´æ˜ï¼š

1. å®‰è£…Node.js (å¦‚æœè¿˜æ²¡æœ‰å®‰è£…)
2. è¿›å…¥ claude-proxy-server ç›®å½•
3. è¿è¡Œ: npm install
4. å¯åŠ¨æœåŠ¡å™¨: npm start
5. æœåŠ¡å™¨å°†åœ¨ http://localhost:3001 è¿è¡Œ

è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ claude-proxy-server/README.md`);
        }
        
        // å±•å¼€/æ”¶èµ·åŠŸèƒ½
        function toggleApiInfo(type) {
            const infoDiv = document.getElementById(type + 'ApiInfo');
            const arrow = document.getElementById(type + 'Arrow');
            
            if (infoDiv.style.display === 'none') {
                infoDiv.style.display = 'block';
                arrow.classList.add('expanded');
            } else {
                infoDiv.style.display = 'none';
                arrow.classList.remove('expanded');
            }
        }
        
        // æ£€æŸ¥Claudeä»£ç†æœåŠ¡å™¨çŠ¶æ€
        async function checkProxyServerStatus() {
            try {
                const response = await fetch(`${CLAUDE_PROXY_URL}/health`);
                if (response.ok) {
                    console.log('Claudeä»£ç†æœåŠ¡å™¨è¿è¡Œæ­£å¸¸');
                    return true;
                }
            } catch (error) {
                console.log('Claudeä»£ç†æœåŠ¡å™¨æœªè¿è¡Œ');
                return false;
            }
            return false;
        }
        
        // æ˜¾ç¤ºæœåŠ¡å™¨çŠ¶æ€æç¤º
        async function showServerStatusNotification() {
            const usesClaude = document.getElementById('useClaude').checked;
            if (usesClaude) {
                const isRunning = await checkProxyServerStatus();
                if (!isRunning) {
                    const message = `Claudeä»£ç†æœåŠ¡å™¨æœªè¿è¡Œï¼\n\nè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼š\n1. cd claude-proxy-server\n2. npm start\n\næˆ–è€…åŒå‡»"å¯åŠ¨Hunterå·¥å…·.command"æ–‡ä»¶`;
                    alert(message);
                }
            }
        }
        
        // CSVæ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        async function previewCsvFile() {
            const fileInput = document.getElementById('greetingCsvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('csvPreview').style.display = 'none';
                return;
            }
            
            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    alert('CSVæ–‡ä»¶ä¸ºç©º');
                    return;
                }
                
                // è§£æCSVå¤´éƒ¨
                const headers = parseCSVLine(lines[0]);
                
                // å°è¯•æ‰¾åˆ°emailåˆ—
                const emailColumnIndex = headers.findIndex(header => 
                    header.toLowerCase().includes('email') || 
                    header.toLowerCase() === 'e-mail' ||
                    header.toLowerCase() === 'mail'
                );
                
                if (emailColumnIndex === -1) {
                    alert('æœªæ‰¾åˆ°emailåˆ—ï¼Œè¯·ç¡®ä¿CSVæ–‡ä»¶åŒ…å«emailåˆ—');
                    return;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const previewDiv = document.getElementById('csvPreview');
                const previewContent = document.getElementById('csvPreviewContent');
                const detectedColumns = document.getElementById('detectedColumns');
                
                previewDiv.style.display = 'block';
                detectedColumns.textContent = headers.join(', ');
                
                // æ˜¾ç¤ºå‰5è¡Œæ•°æ®
                let previewHtml = '<table style="width: 100%; font-size: 12px;">';
                previewHtml += '<thead><tr>';
                headers.forEach((header, index) => {
                    const highlight = index === emailColumnIndex ? 'style="background: #e6f2ff; font-weight: bold;"' : '';
                    previewHtml += `<th ${highlight}>${escapeHtml(header)}</th>`;
                });
                previewHtml += '</tr></thead><tbody>';
                
                for (let i = 1; i < Math.min(6, lines.length); i++) {
                    const values = parseCSVLine(lines[i]);
                    previewHtml += '<tr>';
                    values.forEach((value, index) => {
                        const highlight = index === emailColumnIndex ? 'style="background: #e6f2ff;"' : '';
                        previewHtml += `<td ${highlight}>${escapeHtml(value || '')}</td>`;
                    });
                    previewHtml += '</tr>';
                }
                
                previewHtml += '</tbody></table>';
                previewHtml += `<div style="margin-top: 10px; color: #666;">å…± ${lines.length - 1} è¡Œæ•°æ®</div>`;
                
                previewContent.innerHTML = previewHtml;
                
                // ä¿å­˜è§£æä¿¡æ¯ä¾›åç»­ä½¿ç”¨
                window.csvParseInfo = {
                    headers,
                    emailColumnIndex,
                    totalRows: lines.length - 1
                };
                
            } catch (error) {
                alert('è¯»å–CSVæ–‡ä»¶å¤±è´¥: ' + error.message);
                AppLogger.error('CSVæ–‡ä»¶è¯»å–å¤±è´¥', { error: error.message });
            }
        }
        
        // è§£æCSVè¡Œï¼ˆå¤„ç†é€—å·å’Œå¼•å·ï¼‰
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values;
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ä»…ç”Ÿæˆç§°å‘¼åŠŸèƒ½
        async function generateGreetingsOnly() {
            const fileInput = document.getElementById('greetingCsvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥AIè®¾ç½®
            const enableGuessing = document.getElementById('enableNameGuessing').checked;
            if (!enableGuessing) {
                alert('è¯·å…ˆå¯ç”¨"æ™ºèƒ½çŒœæµ‹åå­—"åŠŸèƒ½');
                return;
            }
            
            const useOpenAI = document.getElementById('useOpenAI').checked;
            const openaiKey = localStorage.getItem('openaiApiKey');
            const claudeKey = localStorage.getItem('claudeApiKey');
            const hasValidKey = useOpenAI ? openaiKey : claudeKey;
            
            if (!hasValidKey) {
                alert(`è¯·å…ˆè®¾ç½®${useOpenAI ? 'OpenAI' : 'Claude'} APIå¯†é’¥`);
                return;
            }
            
            try {
                showLoading(true);
                updateLoadingText('æ­£åœ¨è¯»å–CSVæ–‡ä»¶...');
                
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (!window.csvParseInfo) {
                    alert('è¯·é‡æ–°é€‰æ‹©æ–‡ä»¶');
                    return;
                }
                
                const { headers, emailColumnIndex } = window.csvParseInfo;
                const overrideExisting = document.getElementById('overrideGreetings').checked;
                
                // æŸ¥æ‰¾å¯èƒ½çš„åå­—åˆ—
                const firstNameIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('first') || 
                    h.toLowerCase() === 'firstname' ||
                    h.toLowerCase() === 'fname'
                );
                const lastNameIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('last') || 
                    h.toLowerCase() === 'lastname' ||
                    h.toLowerCase() === 'lname'
                );
                const companyIndex = headers.findIndex(h => 
                    h.toLowerCase().includes('company') || 
                    h.toLowerCase() === 'organization'
                );
                
                // æ”¶é›†éœ€è¦å¤„ç†çš„é‚®ç®±
                const emailsToProcess = [];
                const processedData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    const email = values[emailColumnIndex];
                    
                    if (!email || !email.includes('@')) continue;
                    
                    const hasFirstName = firstNameIndex !== -1 && values[firstNameIndex];
                    const shouldProcess = overrideExisting || !hasFirstName;
                    
                    const rowData = {
                        originalIndex: i,
                        values: [...values],
                        email: email,
                        company: companyIndex !== -1 ? values[companyIndex] : email.split('@')[1]
                    };
                    
                    if (shouldProcess) {
                        emailsToProcess.push({
                            email: email,
                            companyName: rowData.company
                        });
                    }
                    
                    processedData.push(rowData);
                }
                
                AppLogger.info('CSVåˆ†æå®Œæˆ', {
                    totalRows: processedData.length,
                    toProcess: emailsToProcess.length
                });
                
                if (emailsToProcess.length === 0) {
                    alert('æ²¡æœ‰éœ€è¦å¤„ç†çš„é‚®ç®±ï¼ˆæ‰€æœ‰é‚®ç®±éƒ½å·²æœ‰åå­—ï¼‰');
                    showLoading(false);
                    return;
                }
                
                // æ™ºèƒ½è®¡ç®—æœ€ä¼˜æ‰¹æ¬¡ç­–ç•¥
                const totalEmails = emailsToProcess.length;
                let batchStrategy = [];
                
                if (totalEmails <= 30) {
                    // 30ä¸ªä»¥å†…ï¼Œä¸€æ¬¡å¤„ç†å®Œ
                    batchStrategy = [totalEmails];
                } else if (totalEmails <= 60) {
                    // 31-60ä¸ªï¼Œåˆ†2æ‰¹ï¼Œæ¯æ‰¹30ä¸ª
                    batchStrategy = [30, totalEmails - 30];
                } else if (totalEmails <= 100) {
                    // 61-100ä¸ªï¼Œå‰å‡ æ‰¹30ä¸ªï¼Œæœ€åä¸€æ‰¹å¤„ç†å‰©ä½™
                    const fullBatches = Math.floor(totalEmails / 30);
                    const remainder = totalEmails % 30;
                    batchStrategy = Array(fullBatches).fill(30);
                    if (remainder > 0) {
                        if (remainder < 10 && fullBatches > 0) {
                            // å¦‚æœå‰©ä½™å°‘äº10ä¸ªï¼Œåˆå¹¶åˆ°ä¸Šä¸€æ‰¹
                            batchStrategy[batchStrategy.length - 1] += remainder;
                        } else {
                            batchStrategy.push(remainder);
                        }
                    }
                } else {
                    // 100ä¸ªä»¥ä¸Šï¼Œæ¯æ‰¹25ä¸ªï¼Œé¿å…å•æ‰¹è¿‡å¤§
                    const batchSize = 25;
                    const fullBatches = Math.floor(totalEmails / batchSize);
                    const remainder = totalEmails % batchSize;
                    batchStrategy = Array(fullBatches).fill(batchSize);
                    if (remainder > 0) {
                        if (remainder < 10 && fullBatches > 0) {
                            batchStrategy[batchStrategy.length - 1] += remainder;
                        } else {
                            batchStrategy.push(remainder);
                        }
                    }
                }
                
                // æ˜¾ç¤ºæ‰¹æ¬¡ç­–ç•¥
                const strategyText = batchStrategy.map((size, index) => 
                    `ç¬¬${index + 1}æ‰¹: ${size}ä¸ª`
                ).join(', ');
                
                AppLogger.info('AIæ‰¹æ¬¡å¤„ç†ç­–ç•¥', {
                    totalEmails,
                    strategy: batchStrategy,
                    strategyText
                });
                
                updateLoadingText(`æ­£åœ¨åˆ†æå¤„ç†ç­–ç•¥... å…±${totalEmails}ä¸ªé‚®ç®±å°†åˆ†${batchStrategy.length}æ‰¹å¤„ç† (${strategyText})`);
                await delay(1000);
                
                // æŒ‰ç…§ç­–ç•¥æ‰¹é‡å¤„ç†
                const aiResults = new Map();
                let processedCount = 0;
                
                for (let batchIndex = 0; batchIndex < batchStrategy.length; batchIndex++) {
                    const batchSize = batchStrategy[batchIndex];
                    const batch = emailsToProcess.slice(processedCount, processedCount + batchSize);
                    
                    updateLoadingText(`æ­£åœ¨å¤„ç†ç¬¬ ${batchIndex + 1}/${batchStrategy.length} æ‰¹ (${processedCount + 1}-${processedCount + batch.length}/${totalEmails})...`);
                    
                    const batchResults = await batchProcessEmailsWithAI(batch);
                    batchResults.forEach((result, email) => {
                        aiResults.set(email, result);
                    });
                    
                    processedCount += batch.length;
                    
                    // æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…APIé™æµ
                    if (batchIndex < batchStrategy.length - 1) {
                        updateLoadingText(`ç¬¬ ${batchIndex + 1} æ‰¹å®Œæˆï¼Œç­‰å¾…1ç§’åç»§ç»­...`);
                        await delay(1000);
                    }
                }
                
                // åº”ç”¨AIç»“æœåˆ°æ•°æ®
                let updatedCount = 0;
                let firstNameAdded = false;
                
                processedData.forEach(row => {
                    const aiResult = aiResults.get(row.email);
                    if (aiResult) {
                        // æ›´æ–°æˆ–æ·»åŠ first_nameåˆ—
                        if (firstNameIndex !== -1) {
                            if (overrideExisting || !row.values[firstNameIndex]) {
                                row.values[firstNameIndex] = aiResult.first_name || '';
                                updatedCount++;
                            }
                        } else {
                            // å¦‚æœæ²¡æœ‰first_nameåˆ—ï¼Œæ·»åŠ ä¸€ä¸ª
                            if (!firstNameAdded) {
                                headers.push('first_name');
                                firstNameAdded = true;
                            }
                            row.values.push(aiResult.first_name || '');
                            updatedCount++;
                        }
                        
                        // æ›´æ–°æˆ–æ·»åŠ last_nameåˆ—ï¼ˆå¦‚æœAIè¿”å›äº†ï¼‰
                        if (aiResult.last_name && lastNameIndex !== -1) {
                            if (!row.values[lastNameIndex]) {
                                row.values[lastNameIndex] = aiResult.last_name;
                            }
                        }
                    } else if (firstNameIndex === -1 && firstNameAdded) {
                        // å¦‚æœæ·»åŠ äº†first_nameåˆ—ï¼Œç¡®ä¿æ‰€æœ‰è¡Œéƒ½æœ‰ç›¸åº”çš„å€¼
                        row.values.push('');
                    }
                });
                
                // ç”Ÿæˆæ–°çš„CSV
                updateLoadingText('æ­£åœ¨ç”ŸæˆCSVæ–‡ä»¶...');
                
                const BOM = '\uFEFF';
                let newCsv = BOM + headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
                
                processedData.forEach(row => {
                    newCsv += row.values.map(v => {
                        const str = String(v || '');
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return `"${str}"`;
                    }).join(',') + '\n';
                });
                
                // ä¿å­˜ç”Ÿæˆçš„CSVåˆ°å…¨å±€å˜é‡
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const originalName = file.name.replace('.csv', '');
                const fileName = `${originalName}_with_greetings_${timestamp}.csv`;
                
                window.generatedGreetingCsv = {
                    content: newCsv,
                    fileName: fileName,
                    processedCount: emailsToProcess.length,
                    updatedCount: updatedCount
                };
                
                // æ˜¾ç¤ºç»“æœå’Œä¸‹è½½æŒ‰é’®
                showGreetingResults();
                
                AppLogger.info('CSVç§°å‘¼ç”Ÿæˆå®Œæˆ', {
                    processed: emailsToProcess.length,
                    updated: updatedCount
                });
                
            } catch (error) {
                AppLogger.error('ç”Ÿæˆç§°å‘¼å¤±è´¥', { error: error.message });
                alert('ç”Ÿæˆç§°å‘¼å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // æ˜¾ç¤ºç§°å‘¼ç”Ÿæˆç»“æœ
        function showGreetingResults() {
            const results = window.generatedGreetingCsv;
            if (!results) return;
            
            const resultDiv = document.getElementById('greetingResults');
            const resultText = document.getElementById('greetingResultText');
            
            resultText.innerHTML = `
                <strong>å¤„ç†å®Œæˆï¼</strong><br>
                â€¢ å¤„ç†äº† ${results.processedCount} ä¸ªé‚®ç®±<br>
                â€¢ æ›´æ–°äº† ${results.updatedCount} ä¸ªåå­—<br>
                â€¢ æ–‡ä»¶åï¼š${results.fileName}
            `;
            
            resultDiv.style.display = 'block';
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ä¸‹è½½ç”Ÿæˆçš„ç§°å‘¼æ–‡ä»¶
        function downloadGeneratedGreetings() {
            const results = window.generatedGreetingCsv;
            if (!results) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }
            
            downloadFile(results.content, results.fileName, 'text/csv;charset=utf-8');
            
            AppLogger.info('ä¸‹è½½ç§°å‘¼æ–‡ä»¶', { fileName: results.fileName });
        }
        
        // æ¸…é™¤ç§°å‘¼ç”Ÿæˆç»“æœ
        function clearGreetingResults() {
            document.getElementById('greetingResults').style.display = 'none';
            document.getElementById('greetingCsvFile').value = '';
            document.getElementById('csvPreview').style.display = 'none';
            window.generatedGreetingCsv = null;
            window.csvParseInfo = null;
        }
        
        // JSONæ–‡ä»¶å¤„ç†ç›¸å…³åŠŸèƒ½
        async function previewJsonFile() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('jsonPreview').style.display = 'none';
                return;
            }
            
            try {
                const text = await file.text();
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const previewDiv = document.getElementById('jsonPreview');
                const previewContent = document.getElementById('jsonPreviewContent');
                const jsonStats = document.getElementById('jsonStats');
                
                previewDiv.style.display = 'block';
                
                // æ˜¾ç¤ºå‰1000ä¸ªå­—ç¬¦
                const previewText = text.length > 1000 ? text.substring(0, 1000) + '...\n(æ–‡ä»¶è¿‡å¤§ï¼Œä»…æ˜¾ç¤ºå‰1000ä¸ªå­—ç¬¦)' : text;
                previewContent.textContent = previewText;
                
                // å°è¯•è§£æå¹¶ç»Ÿè®¡
                const { results, errors } = parseMultiArrayJSON(text);
                const stats = `æ‰¾åˆ° ${results.length} æ¡è®°å½•${errors.length > 0 ? `, ${errors.length} ä¸ªè­¦å‘Š` : ''}`;
                jsonStats.textContent = stats;
                
                // ä¿å­˜è§£æç»“æœä¾›åç»­ä½¿ç”¨
                window.jsonParsePreview = { text, results, errors };
                
            } catch (error) {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥: ' + error.message);
                AppLogger.error('JSONæ–‡ä»¶è¯»å–å¤±è´¥', { error: error.message });
            }
        }
        
        // å¤„ç†JSONæ–‡ä»¶
        async function processJsonFile() {
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            try {
                showLoading(true);
                updateLoadingText('æ­£åœ¨å¤„ç†JSONæ–‡ä»¶...');
                
                // ä½¿ç”¨é¢„è§ˆæ—¶çš„è§£æç»“æœæˆ–é‡æ–°è§£æ
                let parseResult;
                if (window.jsonParsePreview && window.jsonParsePreview.text) {
                    parseResult = window.jsonParsePreview;
                } else {
                    const text = await file.text();
                    parseResult = { ...parseMultiArrayJSON(text), text };
                }
                
                let { results, errors } = parseResult;
                const originalCount = results.length;
                
                // å»é‡å¤„ç†
                const removeDuplicates = document.getElementById('removeDuplicates').checked;
                if (removeDuplicates && results.length > 0) {
                    updateLoadingText('æ­£åœ¨å»é™¤é‡å¤æ•°æ®...');
                    const domainMap = new Map();
                    
                    results.forEach(item => {
                        const domain = extractDomain(item.domain);
                        if (domain && !domainMap.has(domain)) {
                            domainMap.set(domain, {
                                company_name: item.company_name || domain,
                                domain: domain
                            });
                        }
                    });
                    
                    results = Array.from(domainMap.values());
                }
                
                const duplicatesRemoved = originalCount - results.length;
                
                // ä¿å­˜å¤„ç†ç»“æœ
                window.processedJsonData = {
                    results,
                    originalCount,
                    duplicatesRemoved,
                    errors,
                    fileName: file.name
                };
                
                // æ˜¾ç¤ºç»“æœ
                showJsonResults();
                
                AppLogger.info('JSONæ–‡ä»¶å¤„ç†å®Œæˆ', {
                    originalCount,
                    finalCount: results.length,
                    duplicatesRemoved,
                    errors: errors.length
                });
                
            } catch (error) {
                AppLogger.error('å¤„ç†JSONæ–‡ä»¶å¤±è´¥', { error: error.message });
                alert('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // æ˜¾ç¤ºJSONå¤„ç†ç»“æœ
        function showJsonResults() {
            const data = window.processedJsonData;
            if (!data) return;
            
            const resultDiv = document.getElementById('jsonResults');
            const resultText = document.getElementById('jsonResultText');
            
            resultText.innerHTML = `
                <strong>å¤„ç†ç»Ÿè®¡ï¼š</strong><br>
                â€¢ åŸå§‹è®°å½•æ•°ï¼š${data.originalCount}<br>
                â€¢ å»é™¤é‡å¤ï¼š${data.duplicatesRemoved}<br>
                â€¢ æœ€ç»ˆè®°å½•æ•°ï¼š${data.results.length}<br>
                ${data.errors.length > 0 ? `â€¢ å¤„ç†è­¦å‘Šï¼š${data.errors.length} ä¸ª<br>` : ''}
                â€¢ æ–‡ä»¶åï¼š${data.fileName}
            `;
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ä¸‹è½½å¤„ç†åçš„JSON
        function downloadProcessedJson() {
            const data = window.processedJsonData;
            if (!data || !data.results) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }
            
            const jsonContent = JSON.stringify(data.results, null, 2);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const fileName = `processed_companies_${timestamp}.json`;
            
            downloadFile(jsonContent, fileName, 'application/json');
            AppLogger.info('ä¸‹è½½JSONæ–‡ä»¶', { fileName, count: data.results.length });
        }
        
        // ä¸‹è½½å¤„ç†åçš„CSV
        function downloadProcessedCsv() {
            const data = window.processedJsonData;
            if (!data || !data.results) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®');
                return;
            }
            
            const BOM = '\uFEFF';
            let csv = BOM + 'company_name,domain\n';
            
            data.results.forEach(item => {
                const companyName = (item.company_name || '').replace(/"/g, '""');
                const domain = (item.domain || '').replace(/"/g, '""');
                csv += `"${companyName}","${domain}"\n`;
            });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const fileName = `processed_companies_${timestamp}.csv`;
            
            downloadFile(csv, fileName, 'text/csv;charset=utf-8');
            AppLogger.info('ä¸‹è½½CSVæ–‡ä»¶', { fileName, count: data.results.length });
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        async function copyToClipboard() {
            const data = window.processedJsonData;
            if (!data || !data.results) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„æ•°æ®');
                return;
            }
            
            try {
                const jsonContent = JSON.stringify(data.results, null, 2);
                await navigator.clipboard.writeText(jsonContent);
                alert(`å·²å¤åˆ¶ ${data.results.length} æ¡è®°å½•åˆ°å‰ªè´´æ¿`);
                AppLogger.info('å¤åˆ¶åˆ°å‰ªè´´æ¿', { count: data.results.length });
            } catch (error) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä¸‹è½½');
                AppLogger.error('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥', { error: error.message });
            }
        }
        
        // æ¸…é™¤JSONå¤„ç†ç»“æœ
        function clearJsonResults() {
            document.getElementById('jsonResults').style.display = 'none';
            document.getElementById('jsonFile').value = '';
            document.getElementById('jsonPreview').style.display = 'none';
            window.processedJsonData = null;
            window.jsonParsePreview = null;
        }
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            window.scrollTo({
                top: document.documentElement.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ™ºèƒ½æ˜¾ç¤º/éšè—æŒ‰é’®
        let scrollTimer;
        window.addEventListener('scroll', function() {
            const scrollButtons = document.querySelector('.scroll-buttons');
            
            // æ˜¾ç¤ºæŒ‰é’®
            if (scrollButtons) {
                scrollButtons.classList.remove('hidden');
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(scrollTimer);
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ3ç§’åéšè—
                scrollTimer = setTimeout(() => {
                    scrollButtons.classList.add('hidden');
                }, 3000);
            }
        });
        
        // å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function(event) {
            AppLogger.error('å…¨å±€é”™è¯¯', {
                message: event.message,
                filename: event.filename,
                line: event.lineno,
                column: event.colno,
                error: event.error?.stack
            });
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            AppLogger.error('æœªå¤„ç†çš„Promiseé”™è¯¯', {
                reason: event.reason,
                promise: event.promise
            });
        });
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åŠ è½½ä¿å­˜çš„æ—¥å¿—
            AppLogger.loadLogs();
            AppLogger.info('Hunteré‚®ç®±æŸ¥æ‰¾å·¥å…·å¯åŠ¨', { 
                version: '1.0',
                userAgent: navigator.userAgent 
            });
            // ä¿å­˜APIå¯†é’¥åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆè¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜ï¼‰
            const apiKeyInput = document.getElementById('apiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', debounce(function() {
                    const apiKey = this.value ? this.value.trim() : '';
                    if (apiKey) {
                        localStorage.setItem('hunterApiKey', apiKey);
                    }
                }, 1000));
            }

            // æ¢å¤ä¿å­˜çš„APIå¯†é’¥
            const savedApiKey = localStorage.getItem('hunterApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                showApiStatus('å·²åŠ è½½ä¿å­˜çš„APIå¯†é’¥', 'success');
                // è‡ªåŠ¨æµ‹è¯•è¿æ¥å¹¶æ›´æ–°é…é¢
                setTimeout(async () => {
                    await testApiKey();
                }, 500);
            }

            // æ¢å¤ä¿å­˜çš„OpenAI APIå¯†é’¥
            const savedOpenAIKey = localStorage.getItem('openaiApiKey');
            if (savedOpenAIKey) {
                document.getElementById('openaiKey').value = savedOpenAIKey;
                showOpenAIStatus('å·²åŠ è½½ä¿å­˜çš„OpenAI APIå¯†é’¥', 'success');
            }
            
            // æ¢å¤ä¿å­˜çš„Claude APIå¯†é’¥
            const savedClaudeKey = localStorage.getItem('claudeApiKey');
            if (savedClaudeKey) {
                document.getElementById('claudeKey').value = savedClaudeKey;
                showClaudeStatus('å·²åŠ è½½ä¿å­˜çš„Claude APIå¯†é’¥', 'success');
            }
            
            // æ¢å¤AIæä¾›å•†é€‰æ‹©ï¼ˆé»˜è®¤ä½¿ç”¨OpenAIï¼Œå› ä¸ºClaudeæœ‰CORSé™åˆ¶ï¼‰
            const savedAIProvider = localStorage.getItem('aiProvider');
            if (savedAIProvider === 'claude') {
                document.getElementById('useClaude').checked = true;
                // å»¶è¿Ÿæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼Œè®©é¡µé¢å…ˆåŠ è½½å®Œæˆ
                setTimeout(() => {
                    showServerStatusNotification();
                }, 1000);
            } else {
                // é»˜è®¤ä½¿ç”¨OpenAI
                document.getElementById('useOpenAI').checked = true;
                if (!savedAIProvider) {
                    localStorage.setItem('aiProvider', 'openai');
                }
            }

            // æ¢å¤æ™ºèƒ½çŒœæµ‹åå­—çš„è®¾ç½®ï¼ˆé»˜è®¤ä¸ºtrueï¼‰
            const savedEnableNameGuessing = localStorage.getItem('enableNameGuessing');
            const enableNameGuessing = savedEnableNameGuessing === null ? true : savedEnableNameGuessing === 'true';
            document.getElementById('enableNameGuessing').checked = enableNameGuessing;

            // ä¿å­˜æ™ºèƒ½çŒœæµ‹åå­—çš„è®¾ç½®
            document.getElementById('enableNameGuessing').addEventListener('change', function() {
                localStorage.setItem('enableNameGuessing', this.checked);
            });

            // OpenAIå¯†é’¥è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜
            const openaiKeyInput = document.getElementById('openaiKey');
            if (openaiKeyInput) {
                openaiKeyInput.addEventListener('input', debounce(function() {
                    const openaiKey = this.value ? this.value.trim() : '';
                    if (openaiKey) {
                        localStorage.setItem('openaiApiKey', openaiKey);
                    }
                }, 1000));
            }
            
            // Claudeå¯†é’¥è¾“å…¥æ—¶è‡ªåŠ¨ä¿å­˜
            const claudeKeyInput = document.getElementById('claudeKey');
            if (claudeKeyInput) {
                claudeKeyInput.addEventListener('input', debounce(function() {
                    const claudeKey = this.value ? this.value.trim() : '';
                    if (claudeKey) {
                        localStorage.setItem('claudeApiKey', claudeKey);
                    }
                }, 1000));
            }
            
            // ä¿å­˜AIæä¾›å•†é€‰æ‹©
            document.getElementById('useOpenAI').addEventListener('change', function() {
                if (this.checked) {
                    localStorage.setItem('aiProvider', 'openai');
                }
            });
            
            document.getElementById('useClaude').addEventListener('change', async function() {
                if (this.checked) {
                    localStorage.setItem('aiProvider', 'claude');
                    // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
                    await showServerStatusNotification();
                }
            });
            
            // ä¿å­˜ä»£ç†URL
            const proxyUrlInput = document.getElementById('proxyUrl');
            if (proxyUrlInput) {
                // æ¢å¤ä¿å­˜çš„ä»£ç†URL
                const savedProxyUrl = localStorage.getItem('claudeProxyUrl');
                if (savedProxyUrl) {
                    proxyUrlInput.value = savedProxyUrl;
                }
                
                // ç›‘å¬å˜åŒ–å¹¶ä¿å­˜
                proxyUrlInput.addEventListener('input', debounce(function() {
                    const proxyUrl = this.value.trim();
                    if (proxyUrl) {
                        localStorage.setItem('claudeProxyUrl', proxyUrl);
                        // æ›´æ–°å…¨å±€å˜é‡
                        CLAUDE_PROXY_URL = proxyUrl;
                    }
                }, 1000));
            }
        });
    </script>
</body>
</html>